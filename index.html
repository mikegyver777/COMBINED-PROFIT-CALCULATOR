<script>
  function showPrintReport(){
    const week = document.getElementById('collectionWeek').value || 'Not Specified';

    // 1) Build an array of rows with computed values
    const rowsData = state.calculators.map((c, idx) => {
      const d = compute(c);
      return {
        idx,
        jobNumber: c.jobNumber || '-',
        customerName: c.customerName || '-',
        contract: d.contractAmount || 0,
        payout: d.totalTeamPayout || 0,
        profit: d.finalProfit || 0,
        pct: d.profitPercent || 0,
        thisWeek: parseVal(c.moneyThisWeek) || 0,
        bankDropDay: (c.bankDropDay || '').trim()  // <-- used for sorting & display
      };
    });

    // 2) Sort Monday ‚Üí Saturday (unknown/blank at the end)
    const order = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const rank = day => {
      const i = order.indexOf((day || '').trim());
      return i === -1 ? 999 : i;
    };
    rowsData.sort((a, b) => {
      const rA = rank(a.bankDropDay);
      const rB = rank(b.bankDropDay);
      if (rA !== rB) return rA - rB;
      // stable secondary: original index
      return a.idx - b.idx;
    });

    // 3) Aggregate totals (post-sort; totals unaffected by order)
    let totalPayout = 0, totalProfit = 0, totalMoney = 0, totalAfterHouse = 0;
    state.calculators.forEach(c => {
      const d = compute(c);
      totalPayout     += d.totalTeamPayout;
      totalProfit     += d.finalProfit;
      totalMoney      += parseVal(c.moneyThisWeek);
      totalAfterHouse += (d.afterHouseFee - d.dealerFeeAmount);
    });
    const profitPercent = totalAfterHouse > 0 ? (totalProfit / totalAfterHouse) * 100 : 0;

    // 4) Build table rows (now sorted) and include Bank Drop Day column
    const rowsHTML = rowsData.map((r, i) => `
      <tr>
        <td style="border:1px solid #000; padding:6px; text-align:center;">${i + 1}</td>
        <td style="border:1px solid #000; padding:6px;">${r.jobNumber}</td>
        <td style="border:1px solid #000; padding:6px;">${r.customerName}</td>
        <td style="border:1px solid #000; padding:6px; text-align:right;">${fmtMoney(r.contract)}</td>
        <td style="border:1px solid #000; padding:6px; text-align:right;">${fmtMoney(r.payout)}</td>
        <td style="border:1px solid #000; padding:6px; text-align:right;">${fmtMoney(r.profit)}</td>
        <td style="border:1px solid #000; padding:6px; text-align:right;">${r.pct.toFixed(2)}%</td>
        <td style="border:1px solid #000; padding:6px; text-align:right; font-weight:700;">${fmtMoney(r.thisWeek)}</td>
        <td style="border:1px solid #000; padding:6px; text-align:center;">${r.bankDropDay || '-'}</td>
      </tr>
    `).join('');

    const html = `
      <div style="padding:20px; font-size:10px;">
        <h1 style="text-align:center; font-size:18px; margin-bottom:10px;">COMBINED PROFIT REPORT</h1>
        ${week !== 'Not Specified' ? `<h2 style="text-align:center; font-size:14px; margin-bottom:15px;">Week: ${week}</h2>` : ''}

        <table style="width:100%; border-collapse:collapse; border:2px solid #000; margin-bottom:20px;">
          <thead>
            <tr style="background:#e0e0e0;">
              <th style="border:1px solid #000; padding:8px;">#</th>
              <th style="border:1px solid #000; padding:8px;">Job</th>
              <th style="border:1px solid #000; padding:8px;">Customer</th>
              <th style="border:1px solid #000; padding:8px;">Contract</th>
              <th style="border:1px solid #000; padding:8px;">Payout</th>
              <th style="border:1px solid #000; padding:8px;">Profit</th>
              <th style="border:1px solid #000; padding:8px;">%</th>
              <th style="border:1px solid #000; padding:8px;">This Week</th>
              <th style="border:1px solid #000; padding:8px;">Bank Drop Day</th> <!-- NEW -->
            </tr>
          </thead>
          <tbody>
            ${rowsHTML}
            <tr style="background:#FFF9C4; font-weight:700;">
              <td colspan="4" style="border:1px solid #000; padding:8px; text-align:right;">TOTALS:</td>
              <td style="border:1px solid #000; padding:8px; text-align:right;">${fmtMoney(totalPayout)}</td>
              <td style="border:1px solid #000; padding:8px; text-align:right;">${fmtMoney(totalProfit)}</td>
              <td style="border:1px solid #000; padding:8px; text-align:right;">${profitPercent.toFixed(2)}%</td>
              <td style="border:1px solid #000; padding:8px; text-align:right;">${fmtMoney(totalMoney)}</td>
              <td style="border:1px solid #000; padding:8px;"></td>
            </tr>
          </tbody>
        </table>

        <div class="no-print" style="margin-top:20px; text-align:center;">
          <button onclick="window.print()" style="background:#2196F3; color:#fff; padding:12px 30px; border:none; border-radius:6px; font-size:16px; font-weight:700; cursor:pointer; margin-right:10px;">üñ®Ô∏è PRINT</button>
          <button id="closePrintBtn2" style="background:#757575; color:#fff; padding:12px 30px; border:none; border-radius:6px; font-size:16px; font-weight:700; cursor:pointer;">CLOSE</button>
        </div>
      </div>`;

    document.getElementById('printView').innerHTML = html;
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('printView').style.display = 'block';
    document.getElementById('closePrintBtn2').onclick = () => {
      document.getElementById('mainView').style.display = 'block';
      document.getElementById('printView').style.display = 'none';
    };
  }
</script>
