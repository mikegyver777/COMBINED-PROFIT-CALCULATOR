<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Combined Profit Calculator</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; background:#f5f5f5; padding:15px; }
    input,select,button { font-size:16px !important; }

    .container { max-width:1400px; margin:0 auto; }
    .btn{ padding:14px 24px; border:none; border-radius:8px; font-weight:600; cursor:pointer; touch-action:manipulation;}
    .btn-primary{background:#4CAF50;color:#fff}
    .btn-blue{background:#2196F3;color:#fff}
    .btn-red{background:#EF5350;color:#fff}
    .btn-gray{background:#757575;color:#fff}

    .header{background:#fff; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header h1{color:#1976D2; font-size:24px; margin-bottom:15px}
    .header-buttons{display:flex; gap:10px; flex-wrap:wrap}

    .week-input{background:#fff; padding:15px; border-radius:12px; margin-bottom:20px; text-align:center}
    .week-input input{font-size:16px; padding:12px; border:2px solid #2196F3; border-radius:6px; width:100%; max-width:400px}

    .summary-cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-bottom:20px}
    .summary-card{background:linear-gradient(135deg,var(--c1),var(--c2)); padding:15px; border-radius:8px; color:#fff; text-align:center}
    .summary-card.blue{--c1:#42A5F5; --c2:#2196F3}
    .summary-card.purple{--c1:#AB47BC; --c2:#9C27B0}
    .summary-card.green{--c1:#4CAF50; --c2:#45a049}
    .summary-card.red{--c1:#EF5350; --c2:#E53935}
    .summary-card .label{font-size:11px; font-weight:600; margin-bottom:5px}
    .summary-card .value{font-size:20px; font-weight:700}

    .calculator{background:#fff; border:3px solid #ccc; border-radius:12px; margin-bottom:20px; position:relative}
    .calc-header{background:#BBDEFB; padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #000}
    .delete-btn{position:absolute; top:-10px; right:-10px; background:#EF5350; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; cursor:pointer; z-index:10}

    .calc-section{padding:20px}
    .section{margin-bottom:20px; border:3px solid #e0e0e0; border-radius:8px}
    .section-header{padding:12px; font-weight:600; text-align:center}
    .section-header.blue{background:#BBDEFB; color:#1565C0}
    .section-header.green{background:#C8E6C9; color:#2E7D32}
    .section-header.purple{background:#E1BEE7; color:#6A1B9A}
    .section-header.yellow{background:#FFF9C4; color:#F57F17}
    .section-content{padding:15px; background:#fafafa}

    .form-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px}
    .form-group{display:flex; flex-direction:column}
    .form-group label{font-size:12px; font-weight:600; margin-bottom:6px; color:#555}
    .form-group input,.form-group select{padding:12px; border:2px solid #e0e0e0; border-radius:6px; font-size:16px}

    .input-with-symbol{display:flex; align-items:center; background:#fff; border:2px solid #e0e0e0; border-radius:6px; padding:0 12px}
    .input-with-symbol input{border:none; flex:1; padding:12px 0; text-align:right; font-size:16px}

    .big-card{background:linear-gradient(135deg,var(--c1),var(--c2)); color:#fff; padding:20px; text-align:center; border-radius:8px}
    .big-card .label{font-size:12px; font-weight:600; margin-bottom:8px}
    .big-card .value{font-size:28px; font-weight:700}

    .add-btn{background:#2196F3; color:#fff; font-weight:700; padding:18px 35px; border-radius:50px; border:none; font-size:16px; cursor:pointer; display:flex; align-items:center; gap:12px; margin:20px auto}

    .tier-results{background:#fff; padding:12px; border-radius:6px; border:2px solid #e0e0e0; margin-top:10px}
    .tier-info{text-align:center; font-size:11px; font-weight:600; padding:8px; background:#f5f5f5; border-radius:4px; margin-bottom:10px}
    .tier-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px}
    .tier-person{border:2px solid #e0e0e0; border-radius:6px; padding:12px}
    .tier-box{text-align:center; padding:8px; border-radius:4px; margin-bottom:6px}
    .tier-box.light{background:#f5f5f5; border:1px solid #ddd}
    .tier-box.bold{background:#e8f5e9; border:2px solid #4CAF50}
    .tier-box.purple-light{background:#f3e5f5; border:1px solid #ddd}
    .tier-box.purple-bold{background:#f3e5f5; border:2px solid #9C27B0}
    .tier-box .tier-label{font-size:10px; font-weight:600}
    .tier-box .tier-value{font-size:16px; font-weight:700}

    @media print{.no-print{display:none!important}.print-view{display:block!important}}
    .print-view{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div id="mainView" class="no-print">
      <div class="header">
        <h1>COMBINED PROFIT CALCULATOR</h1>
        <div class="header-buttons">
          <button class="btn btn-primary" onclick="app.showSaveDialog()">üíæ SAVE</button>
          <button class="btn btn-blue" onclick="app.showPrintReport()">üñ®Ô∏è PRINT</button>
        </div>
      </div>

      <div class="week-input">
        <label style="display:block;font-weight:700;margin-bottom:10px;">COLLECTION WEEK PERIOD</label>
        <input id="collectionWeek" type="text" inputmode="text" placeholder="10/1-10/6" />
      </div>

      <div id="summaryCards" class="summary-cards"></div>
      <div id="calculators"></div>

      <div style="text-align:center;">
        <button class="add-btn" onclick="app.addCalculator()">
          <span style="font-size:24px;">+</span> ADD NEW FILE
        </button>
      </div>
    </div>

    <div id="printView" class="print-view"></div>
  </div>

  <script>
    const app = {
      calculators: [],
      nextId: 1,

      // ---------- UTIL ----------
      fmt(v){
        const n = Number.isFinite(v) ? v : parseFloat(String(v||0).replace(/[^\d.-]/g,''))||0;
        return '$' + n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
      },
      num(v){
        if (v===undefined||v===null) return 0;
        const n = parseFloat(String(v).replace(/[^\d.-]/g,'')); return Number.isFinite(n)?n:0;
      },
      // robust fee parser (%, fraction, $)
      fee(base, input){
        const B = this.num(base);
        if (input===undefined||input===null||String(input).trim()==='') return 0;
        const raw = String(input).trim();
        const hasPct = raw.includes('%');
        const hasDol = raw.includes('$');
        const n = this.num(raw);
        if (hasDol) return n;
        if (hasPct) return B * (n/100);
        if (n>100) return n;
        if (n>1) return B * (n/100);
        if (n>0) return B * n;
        return 0;
      },

      // ---------- CORE MATH ----------
      calc(data){
        const contractAmount   = this.num(data.contractAmount);
        const laborMaterial    = this.num(data.laborMaterial);
        const houseFeePercent  = this.num(data.houseFeePercent);
        const houseFeeAmount   = (contractAmount * houseFeePercent)/100;

        const dealerFeeAmount     = this.fee(data.financeAmount, data.dealerFee);
        const creditCardFeeAmount = this.fee(data.creditCard,    data.creditCardFee);

        const afterHouseFee   = contractAmount - houseFeeAmount;
        const totalAfterFees  = afterHouseFee - laborMaterial - dealerFeeAmount;
        const percentOfContract = afterHouseFee>0 ? (totalAfterFees/afterHouseFee)*100 : 0;

        let vetRate = 25; let repRate = 20;
        if (percentOfContract>=50){ vetRate=55; repRate=40; }
        else if (percentOfContract>=40){ vetRate=45; repRate=30; }
        else if (percentOfContract>=33){ vetRate=35; repRate=25; }

        const vets = this.num(data.numVets);
        const reps = this.num(data.numReps);
        const people = Math.max(0, vets+reps);

        const vetCommissionTotal = (totalAfterFees * vetRate)/100;
        const repCommissionTotal = (totalAfterFees * repRate)/100;

        const rideAlongCount = this.num(data.numRideAlongs);
        const rideAlongEach  = this.num(data.rideAlong);
        const rideAlongBonus = this.num(data.rideAlongBonus);
        const rideAlongTotal = rideAlongEach * rideAlongCount + rideAlongBonus;

        const perPersonShared = people>0 ? (creditCardFeeAmount + rideAlongEach*rideAlongCount)/people : 0;

        const perVetBase = people>0 ? vetCommissionTotal/people : 0;
        const perRepBase = people>0 ? repCommissionTotal/people : 0;

        const perVet = perVetBase - perPersonShared;
        const perRep = perRepBase - perPersonShared;

        const vetsTotal = perVet * vets;
        const repsTotal = perRep * reps;

        const altaCalTotalPayout = laborMaterial + vetsTotal + repsTotal + rideAlongTotal + creditCardFeeAmount;
        const preliminaryProfit  = afterHouseFee - altaCalTotalPayout - dealerFeeAmount;

        // Additional team
        const canvasserPayout = preliminaryProfit * (this.num(data.canvasserPercent)/100);
        const confirmerPayout = contractAmount    * (this.num(data.confirmerPercent)/100);
        const elisoPayout     = contractAmount    * (this.num(data.elisoPercent)/100);
        const prodMSPayout    = this.num(data.prodMSAmount)  * (this.num(data.prodMSPercent)/100);
        const prodRSPayout    = this.num(data.prodRSAmount)  * (this.num(data.prodRSPercent)/100);
        const prodNCPayout    = this.num(data.prodNCAmount)  * (this.num(data.prodNCPercent)/100);
        const prodABEPayout   = this.num(data.prodABEAmount) * (this.num(data.prodABEPercent)/100);

        const additionalTeamPayout = canvasserPayout + confirmerPayout + elisoPayout +
                                     prodMSPayout + prodRSPayout + prodNCPayout + prodABEPayout;

        const totalTeamPayout = altaCalTotalPayout + additionalTeamPayout;
        const finalProfit     = preliminaryProfit  - additionalTeamPayout;
        const profitPercent   = (afterHouseFee - dealerFeeAmount)>0 ? (finalProfit/(afterHouseFee-dealerFeeAmount))*100 : 0;

        return {
          contractAmount, houseFeeAmount, dealerFeeAmount, creditCardFeeAmount, afterHouseFee,
          totalAfterFees, percentOfContract, vetRate, repRate,
          perVet, perRep, vetsTotal, repsTotal,
          rideAlongTotal, altaCalTotalPayout, preliminaryProfit,
          canvasserPayout, confirmerPayout, elisoPayout, prodMSPayout, prodRSPayout, prodNCPayout, prodABEPayout,
          additionalTeamPayout, totalTeamPayout, finalProfit, profitPercent,
          vets, reps, rideAlongCount
        };
      },

      // ---------- RENDER ----------
      init(){
        document.getElementById('collectionWeek').addEventListener('input', () => this.updateSummary());
        this.addCalculator(); // start with one
      },

      addCalculator(){
        const calc = {
          id:this.nextId++,
          customerName:'', jobNumber:'', contractAmount:'', cashCheck:'', financeAmount:'',
          dealerFee:'', creditCard:'', creditCardFee:'', houseFeePercent:'', laborMaterial:'',
          numVets:'', numReps:'', rideAlong:'', rideAlongBonus:'', numRideAlongs:'',
          canvasserPercent:'2', confirmerPercent:'0.25', elisoPercent:'1.5',
          prodMSPercent:'0.25', prodMSAmount:'', prodRSPercent:'0.25', prodRSAmount:'',
          prodNCPercent:'0.25', prodNCAmount:'',  prodABEPercent:'0.25', prodABEAmount:'',
          moneyThisWeek:'', financeSource:'', bankDropDay:''
        };
        this.calculators.push(calc);
        this.renderCalculator(calc, this.calculators.length-1);
        this.updateSummary();
      },

      deleteCalculator(id){
        if (this.calculators.length<=1){ alert('Cannot delete the last calculator'); return; }
        if (!confirm('Delete this calculator?')) return;
        this.calculators = this.calculators.filter(c=>c.id!==id);
        // re-render all cards once (rare action)
        document.getElementById('calculators').innerHTML='';
        this.calculators.forEach((c,i)=>this.renderCalculator(c,i));
        this.updateSummary();
      },

      renderCalculator(calc, idx){
        const wrap = document.createElement('div');
        wrap.className = 'calculator';
        wrap.id = `calc-${calc.id}`;

        const delBtn = this.calculators.length>1 ? `<button class="delete-btn" onclick="app.deleteCalculator(${calc.id})">√ó</button>` : '';

        wrap.innerHTML = `
          ${delBtn}
          <div class="calc-header">
            <h2 style="font-size:18px;font-weight:700;">FILE #${idx+1}</h2>
            <button class="btn btn-blue" onclick="app.printSingle(${idx})" style="padding:10px 16px;">üñ®Ô∏è</button>
          </div>

          <div class="calc-section">
            <div class="form-grid" style="margin-bottom:20px;">
              <div class="form-group">
                <label>JOB NUMBER</label>
                <input type="text" inputmode="text" value="${calc.jobNumber}"
                  oninput="app.updateField(${calc.id},'jobNumber',this.value)">
              </div>
              <div class="form-group">
                <label>CUSTOMER NAME</label>
                <input type="text" inputmode="text" value="${calc.customerName}"
                  oninput="app.updateField(${calc.id},'customerName',this.value)">
              </div>
            </div>

            <div class="section">
              <div class="section-header blue">CONTRACT & PAYMENT</div>
              <div class="section-content">
                <div class="form-grid">
                  <div class="form-group">
                    <label>CONTRACT AMOUNT</label>
                    <div class="input-with-symbol">
                      <span>$</span>
                      <input type="text" inputmode="decimal" value="${calc.contractAmount}"
                        oninput="app.updateField(${calc.id},'contractAmount',this.value)">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>CASH/CHECK</label>
                    <div class="input-with-symbol">
                      <span>$</span>
                      <input type="text" inputmode="decimal" value="${calc.cashCheck}"
                        oninput="app.updateField(${calc.id},'cashCheck',this.value)">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>LABOR & MATERIAL</label>
                    <div class="input-with-symbol">
                      <span>$</span>
                      <input type="text" inputmode="decimal" value="${calc.laborMaterial}"
                        oninput="app.updateField(${calc.id},'laborMaterial',this.value)">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>FINANCE AMOUNT</label>
                    <div class="input-with-symbol">
                      <span>$</span>
                      <input type="text" inputmode="decimal" value="${calc.financeAmount}"
                        oninput="app.updateField(${calc.id},'financeAmount',this.value)">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>DEALER FEE (% or $)</label>
                    <input type="text" inputmode="decimal" value="${calc.dealerFee}" placeholder="3.5 or $150"
                      oninput="app.updateField(${calc.id},'dealerFee',this.value)">
                    <div id="v-${calc.id}-dealerFeeAmount" style="text-align:center;font-weight:600;margin-top:5px;color:#2196F3;"></div>
                  </div>
                  <div class="form-group">
                    <label>HOUSE FEE %</label>
                    <div class="input-with-symbol">
                      <input type="text" inputmode="decimal" value="${calc.houseFeePercent}"
                        oninput="app.updateField(${calc.id},'houseFeePercent',this.value)">
                      <span>%</span>
                    </div>
                    <div id="v-${calc.id}-houseFeeAmount" style="text-align:center;font-weight:600;margin-top:5px;"></div>
                  </div>
                  <div class="form-group">
                    <label>CREDIT CARD</label>
                    <div class="input-with-symbol">
                      <span>$</span>
                      <input type="text" inputmode="decimal" value="${calc.creditCard}"
                        oninput="app.updateField(${calc.id},'creditCard',this.value)">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>CC FEE (% or $)</label>
                    <input type="text" inputmode="decimal" value="${calc.creditCardFee}" placeholder="3.5 or $35"
                      oninput="app.updateField(${calc.id},'creditCardFee',this.value)">
                    <div id="v-${calc.id}-creditCardFeeAmount" style="text-align:center;font-weight:600;margin-top:5px;color:#2196F3;"></div>
                  </div>
                  <div class="form-group">
                    <label>AFTER HOUSE FEE</label>
                    <div id="v-${calc.id}-afterHouseFee"
                         style="text-align:center; padding:15px; background:#BBDEFB; border-radius:6px; font-weight:700; font-size:18px;">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-header green">ALTA CAL TEAM</div>
              <div class="section-content">
                <div class="form-grid" style="margin-bottom:10px;">
                  <div class="form-group">
                    <label>VETS ON CONTRACT</label>
                    <input type="text" inputmode="decimal" value="${calc.numVets}"
                      oninput="app.updateField(${calc.id},'numVets',this.value)" style="text-align:center;font-size:18px;">
                  </div>
                  <div class="form-group">
                    <label>REPS ON CONTRACT</label>
                    <input type="text" inputmode="decimal" value="${calc.numReps}"
                      oninput="app.updateField(${calc.id},'numReps',this.value)" style="text-align:center;font-size:18px;">
                  </div>
                  <div class="form-group">
                    <label>RIDE ALONGS</label>
                    <input type="text" inputmode="decimal" value="${calc.numRideAlongs}"
                      oninput="app.updateField(${calc.id},'numRideAlongs',this.value)" style="text-align:center;font-size:18px;">
                  </div>
                </div>

                <div class="tier-results" id="v-${calc.id}-tierBlock" style="display:none;">
                  <div class="tier-info" id="v-${calc.id}-tierInfo"></div>
                  <div class="tier-grid">
                    <div class="tier-person" id="v-${calc.id}-vetsBox" style="display:none;">
                      <div style="font-weight:700; text-align:center; margin-bottom:8px;" id="v-${calc.id}-vetsCount"></div>
                      <div class="tier-box light">
                        <div class="tier-label">Per Vet</div>
                        <div class="tier-value" style="color:#2E7D32;" id="v-${calc.id}-perVet"></div>
                      </div>
                      <div class="tier-box bold">
                        <div class="tier-label">Total</div>
                        <div class="tier-value" style="color:#1B5E20;" id="v-${calc.id}-vetsTotal"></div>
                      </div>
                    </div>

                    <div class="tier-person" id="v-${calc.id}-repsBox" style="display:none;">
                      <div style="font-weight:700; text-align:center; margin-bottom:8px;" id="v-${calc.id}-repsCount"></div>
                      <div class="tier-box purple-light">
                        <div class="tier-label">Per Rep</div>
                        <div class="tier-value" style="color:#6A1B9A;" id="v-${calc.id}-perRep"></div>
                      </div>
                      <div class="tier-box purple-bold">
                        <div class="tier-label">Total</div>
                        <div class="tier-value" style="color:#4A148C;" id="v-${calc.id}-repsTotal"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-grid" style="margin-top:10px;">
                  <div class="form-group">
                    <label style="color:#D32F2F;">RIDE ALONG FEE (each)</label>
                    <div class="input-with-symbol" style="background:#FFEBEE; border-color:#EF5350;">
                      <span>$</span>
                      <input type="text" inputmode="decimal" value="${calc.rideAlong}"
                        oninput="app.updateField(${calc.id},'rideAlong',this.value)" style="background:transparent;">
                    </div>
                  </div>
                  <div class="form-group">
                    <label style="color:#D32F2F;">RIDE ALONG BONUS (flat)</label>
                    <div class="input-with-symbol" style="background:#FFEBEE; border-color:#EF5350;">
                      <span>$</span>
                      <input type="text" inputmode="decimal" value="${calc.rideAlongBonus}"
                        oninput="app.updateField(${calc.id},'rideAlongBonus',this.value)" style="background:transparent;">
                    </div>
                  </div>
                  <div class="form-group" id="v-${calc.id}-ridePayoutWrap" style="display:none;">
                    <label>RIDE ALONG PAYOUT</label>
                    <div id="v-${calc.id}-rideAlongTotal"
                         style="text-align:center; padding:12px; background:#FFCDD2; border:2px solid #EF5350; border-radius:6px; font-weight:700; font-size:16px;">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-header purple">ADDITIONAL TEAM</div>
              <div class="section-content">
                <div style="text-align:center; padding:12px; background:#E1BEE7; border:2px solid #9C27B0; border-radius:6px; font-weight:700; margin-bottom:12px;">
                  <div style="font-size:11px; margin-bottom:4px;">ALTA CAL PROFIT</div>
                  <div id="v-${calc.id}-preProfit" style="font-size:18px;"></div>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label>CANVASSER %</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                      <input type="text" inputmode="decimal" value="${calc.canvasserPercent}"
                        oninput="app.updateField(${calc.id},'canvasserPercent',this.value)" style="width:70px;">
                      <span style="font-size:13px;">% = <span id="v-${calc.id}-canvasserP"></span></span>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>CONFIRMER %</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                      <input type="text" inputmode="decimal" value="${calc.confirmerPercent}"
                        oninput="app.updateField(${calc.id},'confirmerPercent',this.value)" style="width:70px;">
                      <span style="font-size:13px;">% = <span id="v-${calc.id}-confirmerP"></span></span>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>ELISO %</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                      <input type="text" inputmode="decimal" value="${calc.elisoPercent}"
                        oninput="app.updateField(${calc.id},'elisoPercent',this.value)" style="width:70px;">
                      <span style="font-size:13px;">% = <span id="v-${calc.id}-elisoP"></span></span>
                    </div>
                  </div>
                </div>

                <div class="form-grid" style="margin-top:12px;">
                  ${[
                    ['MS','prodMSPercent','prodMSAmount','prodMSP'],
                    ['RS','prodRSPercent','prodRSAmount','prodRSP'],
                    ['NC','prodNCPercent','prodNCAmount','prodNCP'],
                    ['ABE','prodABEPercent','prodABEAmount','prodABEP'],
                  ].map(([lbl,pct,amt,vid])=>`
                    <div class="form-group">
                      <label>PROD ${lbl}</label>
                      <div style="display:flex; gap:6px; align-items:center; font-size:13px;">
                        <input type="text" inputmode="decimal" value="${calc[pct]}"
                          oninput="app.updateField(${calc.id},'${pct}',this.value)" style="width:50px;">
                        <span>%</span>
                        <input type="text" inputmode="decimal" value="${calc[amt]}"
                          oninput="app.updateField(${calc.id},'${amt}',this.value)" style="width:80px;">
                        <span>= <span id="v-${calc.id}-${vid}"></span></span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-header yellow">FINANCE & BANK</div>
              <div class="section-content">
                <div class="form-grid">
                  <div class="form-group">
                    <label>MONEY THIS WEEK</label>
                    <div class="input-with-symbol">
                      <span>$</span>
                      <input type="text" inputmode="decimal" value="${calc.moneyThisWeek}"
                        oninput="app.updateField(${calc.id},'moneyThisWeek',this.value)">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>FINANCE SOURCE</label>
                    <select oninput="app.updateField(${calc.id},'financeSource',this.value)">
                      <option value="" ${calc.financeSource===''?'selected':''}>Select</option>
                      <option value="Finance" ${calc.financeSource==='Finance'?'selected':''}>Finance</option>
                      <option value="Cash" ${calc.financeSource==='Cash'?'selected':''}>Cash</option>
                      <option value="Both" ${calc.financeSource==='Both'?'selected':''}>Both</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>BANK DROP DAY</label>
                    <select oninput="app.updateField(${calc.id},'bankDropDay',this.value)">
                      <option value="" ${calc.bankDropDay===''?'selected':''}>Select Day</option>
                      ${['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].map(d=>`
                        <option value="${d}" ${calc.bankDropDay===d?'selected':''}>${d}</option>`).join('')}
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
              <div class="big-card blue">
                <div class="label">ALTA CAL PAYOUT</div>
                <div class="value" id="v-${calc.id}-totalTeamPayout"></div>
              </div>
              <div class="big-card green">
                <div class="label">ALTA CAL PROFIT</div>
                <div class="value" id="v-${calc.id}-finalProfit"></div>
              </div>
            </div>
          </div>
        `;
        document.getElementById('calculators').appendChild(wrap);
        this.updateComputed(calc.id); // initial fill of computed fields
      },

      updateField(id, field, value){
        const calc = this.calculators.find(c=>c.id===id);
        if (!calc) return;
        calc[field] = value;
        this.updateComputed(id);   // update just this card
        this.updateSummary();      // update top totals
      },

      // update the computed text nodes for ONE calculator (no re-render; cursor stays)
      updateComputed(id){
        const calc = this.calculators.find(c=>c.id===id);
        if (!calc) return;
        const d = this.calc(calc);

        const set = (k, v) => { const el = document.getElementById(`v-${id}-${k}`); if (el) el.textContent = v; };

        set('dealerFeeAmount',    d.dealerFeeAmount>0 ? this.fmt(d.dealerFeeAmount) : '');
        set('houseFeeAmount',     d.houseFeeAmount>0 ? this.fmt(d.houseFeeAmount) : '');
        set('creditCardFeeAmount',d.creditCardFeeAmount>0 ? this.fmt(d.creditCardFeeAmount) : '');
        set('afterHouseFee',      this.fmt(d.afterHouseFee));

        // Tier block
        const tierBlock = document.getElementById(`v-${id}-tierBlock`);
        const vetsBox   = document.getElementById(`v-${id}-vetsBox`);
        const repsBox   = document.getElementById(`v-${id}-repsBox`);
        if (tierBlock){
          const any = (d.vets>0 || d.reps>0);
          tierBlock.style.display = any ? '' : 'none';
          if (any){
            set('tierInfo', `Profit: ${d.percentOfContract.toFixed(1)}% ‚Üí Vet: ${d.vetRate}% | Rep: ${d.repRate}%`);
            if (d.vets>0){
              vetsBox.style.display='';
              set('vetsCount', `VETS: ${d.vets}`);
              set('perVet', this.fmt(d.perVet));
              set('vetsTotal', this.fmt(d.vetsTotal));
            } else { vetsBox.style.display='none'; }
            if (d.reps>0){
              repsBox.style.display='';
              set('repsCount', `REPS: ${d.reps}`);
              set('perRep', this.fmt(d.perRep));
              set('repsTotal', this.fmt(d.repsTotal));
            } else { repsBox.style.display='none'; }
          }
        }

        // Ride-along payout block visibility
        const rideWrap = document.getElementById(`v-${id}-ridePayoutWrap`);
        if (rideWrap) rideWrap.style.display = (d.rideAlongCount>0 || this.num(calc.rideAlongBonus)>0) ? '' : 'none';
        set('rideAlongTotal', this.fmt(d.rideAlongTotal));

        // Additional team amounts and bottom cards
        set('preProfit', this.fmt(d.preliminaryProfit));
        set('canvasserP', this.fmt(d.canvasserPayout));
        set('confirmerP', this.fmt(d.confirmerPayout));
        set('elisoP',     this.fmt(d.elisoPayout));
        set('prodMSP',    this.fmt(d.prodMSPayout));
        set('prodRSP',    this.fmt(d.prodRSPayout));
        set('prodNCP',    this.fmt(d.prodNCPayout));
        set('prodABEP',   this.fmt(d.prodABEPayout));
        set('totalTeamPayout', this.fmt(d.totalTeamPayout));
        set('finalProfit',     this.fmt(d.finalProfit));
      },

      updateSummary(){
        let totalPayout=0, totalProfit=0, totalMoney=0, base=0;
        this.calculators.forEach(c=>{
          const d = this.calc(c);
          totalPayout += d.totalTeamPayout;
          totalProfit += d.finalProfit;
          totalMoney  += this.num(c.moneyThisWeek);
          base        += (d.afterHouseFee - d.dealerFeeAmount);
        });
        const pct = base>0 ? (totalProfit/base)*100 : 0;
        document.getElementById('summaryCards').innerHTML = `
          <div class="summary-card blue"><div class="label">TOTAL PAYOUT</div><div class="value">${this.fmt(totalPayout)}</div></div>
          <div class="summary-card purple"><div class="label">TOTAL PROFIT</div><div class="value">${this.fmt(totalProfit)}</div></div>
          <div class="summary-card green"><div class="label">PROFIT %</div><div class="value">${pct.toFixed(2)}%</div></div>
          <div class="summary-card red"><div class="label">MONEY THIS WEEK</div><div class="value">${this.fmt(totalMoney)}</div></div>
        `;
      },

      // ---------- PRINT (unchanged logic; now correct because data correct) ----------
      printSingle(index){
        const calc = this.calculators[index];
        const d = this.calc(calc);
        const week = document.getElementById('collectionWeek').value || 'Not Specified';
        const html = `
          <div style="padding:20px;font-size:11px;">
            <h1 style="text-align:center;font-size:20px;margin-bottom:15px;border-bottom:2px solid #2196F3;padding-bottom:10px;">
              FILE #${index+1} - ${calc.customerName || 'N/A'}
            </h1>
            ${week!=='Not Specified' ? `<div style="text-align:center;font-weight:700;margin-bottom:15px;">Week: ${week}</div>` : ''}

            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:15px;">
              <div style="background:#BBDEFB;padding:10px;border-radius:4px;">
                <strong>Contract:</strong> ${this.fmt(d.contractAmount)}<br/>
                <strong>After House:</strong> ${this.fmt(d.afterHouseFee)}
              </div>
              <div style="background:#C8E6C9;padding:10px;border-radius:4px;">
                <strong>ALTA CAL Payout:</strong> ${this.fmt(d.totalTeamPayout)}<br/>
                <strong>Profit Rate:</strong> ${d.percentOfContract.toFixed(1)}%
              </div>
              <div style="background:#E1BEE7;padding:10px;border-radius:4px;">
                <strong>ALTA CAL Profit:</strong> ${this.fmt(d.finalProfit)}<br/>
                <strong>Vet ${d.vetRate}% | Rep ${d.repRate}%</strong>
              </div>
            </div>

            ${(d.vets>0 || d.reps>0) ? `
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                ${d.vets>0 ? `
                  <div style="border:2px solid #4CAF50;padding:10px;border-radius:4px;">
                    <div style="font-weight:700;margin-bottom:5px;">VETS: ${d.vets}</div>
                    <div>Per: ${this.fmt(d.perVet)}</div>
                    <div><strong>Total: ${this.fmt(d.vetsTotal)}</strong></div>
                  </div>` : '' }
                ${d.reps>0 ? `
                  <div style="border:2px solid #9C27B0;padding:10px;border-radius:4px;">
                    <div style="font-weight:700;margin-bottom:5px;">REPS: ${d.reps}</div>
                    <div>Per: ${this.fmt(d.perRep)}</div>
                    <div><strong>Total: ${this.fmt(d.repsTotal)}</strong></div>
                  </div>` : '' }
              </div>` : ''}

            <div class="no-print" style="margin-top:20px;text-align:center;">
              <button onclick="window.print()" style="background:#2196F3;color:#fff;padding:12px 30px;border:none;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer;margin-right:10px;">üñ®Ô∏è PRINT</button>
              <button onclick="app.closePrint()" style="background:#757575;color:#fff;padding:12px 30px;border:none;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer;">CLOSE</button>
            </div>
          </div>`;
        document.getElementById('printView').innerHTML = html;
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('printView').style.display = 'block';
      },

      showPrintReport(){
        const week = document.getElementById('collectionWeek').value || 'Not Specified';
        let totalPayout=0,totalProfit=0,totalMoney=0,base=0,rows='';
        this.calculators.forEach((c,i)=>{
          const d = this.calc(c);
          totalPayout+=d.totalTeamPayout; totalProfit+=d.finalProfit; totalMoney+=this.num(c.moneyThisWeek); base+=(d.afterHouseFee-d.dealerFeeAmount);
          rows += `
            <tr>
              <td style="border:1px solid #000;padding:6px;text-align:center;">${i+1}</td>
              <td style="border:1px solid #000;padding:6px;">${c.jobNumber||'-'}</td>
              <td style="border:1px solid #000;padding:6px;">${c.customerName||'-'}</td>
              <td style="border:1px solid #000;padding:6px;text-align:right;">${this.fmt(d.contractAmount)}</td>
              <td style="border:1px solid #000;padding:6px;text-align:right;">${this.fmt(d.totalTeamPayout)}</td>
              <td style="border:1px solid #000;padding:6px;text-align:right;">${this.fmt(d.finalProfit)}</td>
              <td style="border:1px solid #000;padding:6px;text-align:right;">${d.profitPercent.toFixed(2)}%</td>
              <td style="border:1px solid #000;padding:6px;text-align:right;font-weight:700;">${this.fmt(this.num(c.moneyThisWeek))}</td>
            </tr>`;
        });
        const pct = base>0 ? (totalProfit/base)*100 : 0;
        const html = `
          <div style="padding:20px;font-size:10px;">
            <h1 style="text-align:center;font-size:18px;margin-bottom:10px;">COMBINED PROFIT REPORT</h1>
            ${week!=='Not Specified'?`<h2 style="text-align:center;font-size:14px;margin-bottom:15px;">Week: ${week}</h2>`:''}
            <table style="width:100%;border-collapse:collapse;border:2px solid #000;margin-bottom:20px;">
              <thead>
                <tr style="background:#e0e0e0;">
                  <th style="border:1px solid #000;padding:8px;">#</th>
                  <th style="border:1px solid #000;padding:8px;">Job</th>
                  <th style="border:1px solid #000;padding:8px;">Customer</th>
                  <th style="border:1px solid #000;padding:8px;">Contract</th>
                  <th style="border:1px solid #000;padding:8px;">Payout</th>
                  <th style="border:1px solid #000;padding:8px;">Profit</th>
                  <th style="border:1px solid #000;padding:8px;">%</th>
                  <th style="border:1px solid #000;padding:8px;">This Week</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                <tr style="background:#FFF9C4;font-weight:700;">
                  <td colspan="4" style="border:1px solid #000;padding:8px;text-align:right;">TOTALS:</td>
                  <td style="border:1px solid #000;padding:8px;text-align:right;">${this.fmt(totalPayout)}</td>
                  <td style="border:1px solid #000;padding:8px;text-align:right;">${this.fmt(totalProfit)}</td>
                  <td style="border:1px solid #000;padding:8px;text-align:right;">${pct.toFixed(2)}%</td>
                  <td style="border:1px solid #000;padding:8px;text-align:right;">${this.fmt(totalMoney)}</td>
                </tr>
              </tbody>
            </table>
            <div class="no-print" style="text-align:center;margin-top:20px;">
              <button onclick="window.print()" style="background:#2196F3;color:#fff;padding:12px 30px;border:none;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer;margin-right:10px;">üñ®Ô∏è PRINT</button>
              <button onclick="app.closePrint()" style="background:#757575;color:#fff;padding:12px 30px;border:none;border-radius:6px;font-size:16px;font-weight:700;cursor:pointer;">CLOSE</button>
            </div>
          </div>`;
        document.getElementById('printView').innerHTML = html;
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('printView').style.display = 'block';
      },

      closePrint(){
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('printView').style.display = 'none';
      },

      showSaveDialog(){
        const name = prompt('Enter report name:');
        if (!name || !name.trim()) return;
        const data = {
          name: name.trim(),
          date: new Date().toISOString(),
          collectionWeek: document.getElementById('collectionWeek').value,
          calculators: this.calculators
        };
        localStorage.setItem('report_'+Date.now(), JSON.stringify(data));
        alert('Report saved!');
      }
    };

    window.addEventListener('DOMContentLoaded',()=>app.init());
  </script>
</body>
</html>
