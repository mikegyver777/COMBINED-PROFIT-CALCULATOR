<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Combined Profit Calculator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 15px; }
    input, select, button { font-size: 16px !important; }

    .container { max-width: 1400px; margin: 0 auto; }
    .btn { padding: 14px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; touch-action: manipulation; }
    .btn-primary { background: #4CAF50; color: white; }
    .btn-blue { background: #2196F3; color: white; }
    .btn-red { background: #EF5350; color: white; }
    .btn-gray { background: #757575; color: white; }

    .header { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #1976D2; font-size: 24px; margin-bottom: 15px; }
    .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }

    .week-input { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
    .week-input input { font-size: 16px; padding: 12px; border: 2px solid #2196F3; border-radius: 6px; width: 100%; max-width: 400px; }

    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .summary-card { background: linear-gradient(135deg, var(--c1), var(--c2)); padding: 15px; border-radius: 8px; color: white; text-align: center; }
    .summary-card.blue { --c1: #42A5F5; --c2: #2196F3; }
    .summary-card.purple { --c1: #AB47BC; --c2: #9C27B0; }
    .summary-card.green { --c1: #4CAF50; --c2: #45a049; }
    .summary-card.red { --c1: #EF5350; --c2: #E53935; }
    .summary-card .label { font-size: 11px; font-weight: 600; margin-bottom: 5px; }
    .summary-card .value { font-size: 20px; font-weight: 700; }

    .calculator { background: white; border: 3px solid #ccc; border-radius: 12px; margin-bottom: 20px; position: relative; }
    .calc-header { background: #BBDEFB; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; }
    .delete-btn { position: absolute; top: -10px; right: -10px; background: #EF5350; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 20px; cursor: pointer; z-index: 10; }

    .calc-section { padding: 20px; }
    .section { margin-bottom: 20px; border: 3px solid #e0e0e0; border-radius: 8px; }
    .section-header { padding: 12px; font-weight: 600; text-align: center; }
    .section-header.blue { background: #BBDEFB; color: #1565C0; }
    .section-header.green { background: #C8E6C9; color: #2E7D32; }
    .section-header.purple { background: #E1BEE7; color: #6A1B9A; }
    .section-header.yellow { background: #FFF9C4; color: #F57F17; }
    .section-content { padding: 15px; background: #fafafa; }

    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #555; }
    .form-group input, .form-group select { padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; }

    .input-with-symbol { display: flex; align-items: center; background: white; border: 2px solid #e0e0e0; border-radius: 6px; padding: 0 12px; }
    .input-with-symbol input { border: none; flex: 1; padding: 12px 0; text-align: right; font-size: 16px; }

    .big-card { background: linear-gradient(135deg, var(--c1), var(--c2)); color: white; padding: 20px; text-align: center; border-radius: 8px; }
    .big-card .label { font-size: 12px; font-weight: 600; margin-bottom: 8px; }
    .big-card .value { font-size: 28px; font-weight: 700; }

    .add-btn { background: #2196F3; color: white; font-weight: 700; padding: 18px 35px; border-radius: 50px; border: none; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin: 20px auto; }

    .tier-results { background: white; padding: 12px; border-radius: 6px; border: 2px solid #e0e0e0; margin-top: 10px; }
    .tier-info { text-align: center; font-size: 11px; font-weight: 600; padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px; }
    .tier-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .tier-person { border: 2px solid #e0e0e0; border-radius: 6px; padding: 12px; }
    .tier-box { text-align: center; padding: 8px; border-radius: 4px; margin-bottom: 6px; }
    .tier-box.light { background: #f5f5f5; border: 1px solid #ddd; }
    .tier-box.bold { background: #e8f5e9; border: 2px solid #4CAF50; }
    .tier-box.purple-light { background: #f3e5f5; border: 1px solid #ddd; }
    .tier-box.purple-bold { background: #f3e5f5; border: 2px solid #9C27B0; }
    .tier-box .tier-label { font-size: 10px; font-weight: 600; }
    .tier-box .tier-value { font-size: 16px; font-weight: 700; }

    /* slightly larger % inputs */
    .pct-input { width: 88px; text-align: right; }

    @media print { .no-print { display: none !important; } .print-view { display: block !important; } }
    .print-view { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="mainView" class="no-print">
      <div class="header">
        <h1>COMBINED PROFIT CALCULATOR</h1>
        <div class="header-buttons">
          <button class="btn btn-primary" onclick="app.showSaveDialog()">üíæ SAVE</button>
          <button class="btn btn-blue" onclick="app.showPrintReport()">üñ®Ô∏è PRINT</button>
        </div>
      </div>

      <div class="week-input">
        <label style="display: block; font-weight: 700; margin-bottom: 10px;">COLLECTION WEEK PERIOD</label>
        <input type="text" inputmode="text" id="collectionWeek" placeholder="10/1-10/6" />
      </div>

      <div id="summaryCards" class="summary-cards"></div>
      <div id="calculators"></div>

      <div style="text-align: center;">
        <button class="add-btn" onclick="app.addCalculator()">
          <span style="font-size: 24px;">+</span> ADD NEW FILE
        </button>
      </div>
    </div>

    <div id="printView" class="print-view"></div>
  </div>

  <script>
    const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

    const app = {
      calculators: [],
      nextId: 1,

      init() {
        this.addCalculator();
        document.getElementById('collectionWeek').addEventListener('input', () => this.updateSummary());
      },

      fmt(value) {
        const n = Number.isFinite(value) ? value : parseFloat(value || 0);
        return '$' + (n || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      },

      parseValue(value) {
        if (value === undefined || value === null) return 0;
        const parsed = parseFloat(String(value).replace(/[,\$%]/g, '').trim());
        return Number.isFinite(parsed) ? parsed : 0;
      },

      parseFeeAmount(baseAmount, feeInput) {
        const base = this.parseValue(baseAmount);
        if (!feeInput && feeInput !== 0) return 0;
        const raw = String(feeInput).trim();
        if (!raw) return 0;

        const hasPct = raw.includes('%');
        const hasDol = raw.includes('$');
        const num = this.parseValue(raw);

        if (hasDol) return num;
        if (hasPct) return (base * num) / 100;
        if (num > 100) return num;
        if (num > 1) return (base * num) / 100;
        if (num > 0) return base * num;
        return 0;
      },

      calculateOne(data) {
        const contractAmount   = this.parseValue(data.contractAmount);
        const laborMaterial    = this.parseValue(data.laborMaterial);
        const houseFeePercent  = this.parseValue(data.houseFeePercent);
        const houseFeeAmount   = (contractAmount * houseFeePercent) / 100;

        const dealerFeeAmount     = this.parseFeeAmount(data.financeAmount, data.dealerFee);
        const creditCardFeeAmount = this.parseFeeAmount(data.creditCard, data.creditCardFee);

        const afterHouseFee   = contractAmount - houseFeeAmount;
        const totalAfterFees  = afterHouseFee - laborMaterial - dealerFeeAmount;
        const percentOfContract = afterHouseFee > 0 ? (totalAfterFees / afterHouseFee) * 100 : 0;

        let vetRate = 25;
        if (percentOfContract >= 50) vetRate = 55;
        else if (percentOfContract >= 40) vetRate = 45;
        else if (percentOfContract >= 33) vetRate = 35;

        let repRate = 20;
        if (percentOfContract >= 50) repRate = 40;
        else if (percentOfContract >= 40) repRate = 30;
        else if (percentOfContract >= 33) repRate = 25;

        const vetsCount   = this.parseValue(data.numVets);
        const repsCount   = this.parseValue(data.numReps);
        const totalPeople = Math.max(0, vetsCount + repsCount);

        const vetCommissionTotal = (totalAfterFees * vetRate) / 100;
        const repCommissionTotal = (totalAfterFees * repRate) / 100;

        const rideAlongCount       = this.parseValue(data.numRideAlongs);
        const rideAlongFeeEach     = this.parseValue(data.rideAlong);
        const rideAlongBonusAmount = this.parseValue(data.rideAlongBonus);
        const totalRideAlongFee    = rideAlongFeeEach * rideAlongCount;
        const totalRideAlongPayout = totalRideAlongFee + rideAlongBonusAmount;

        const perPersonSharedFees  = totalPeople > 0 ? (creditCardFeeAmount + totalRideAlongFee) / totalPeople : 0;

        const perVetBase           = totalPeople > 0 ? (vetCommissionTotal / totalPeople) : 0;
        const perRepBase           = totalPeople > 0 ? (repCommissionTotal / totalPeople) : 0;

        const finalPerVetPayout    = perVetBase - perPersonSharedFees;
        const finalPerRepPayout    = perRepBase - perPersonSharedFees;
        const finalTotalVetsPayout = finalPerVetPayout * vetsCount;
        const finalTotalRepsPayout = finalPerRepPayout * repsCount;

        const altaCalTotalPayout   = laborMaterial + finalTotalVetsPayout + finalTotalRepsPayout + totalRideAlongPayout + creditCardFeeAmount;
        const preliminaryProfit    = afterHouseFee - altaCalTotalPayout - dealerFeeAmount;

        const canvasserPayout = preliminaryProfit * (this.parseValue(data.canvasserPercent) / 100);
        const confirmerPayout = contractAmount   * (this.parseValue(data.confirmerPercent) / 100);
        const elisoPayout     = contractAmount   * (this.parseValue(data.elisoPercent) / 100);
        const prodMSPayout    = this.parseValue(data.prodMSAmount) * (this.parseValue(data.prodMSPercent) / 100);
        const prodRSPayout    = this.parseValue(data.prodRSAmount) * (this.parseValue(data.prodRSPercent) / 100);
        const prodNCPayout    = this.parseValue(data.prodNCAmount) * (this.parseValue(data.prodNCPercent) / 100);
        const prodABEPayout   = this.parseValue(data.prodABEAmount) * (this.parseValue(data.prodABEPercent) / 100);

        const additionalTeamPayout = canvasserPayout + confirmerPayout + elisoPayout + prodMSPayout + prodRSPayout + prodNCPayout + prodABEPayout;
        const totalTeamPayout = altaCalTotalPayout + additionalTeamPayout;
        const finalProfit     = preliminaryProfit - additionalTeamPayout;
        const profitPercent   = (afterHouseFee - dealerFeeAmount) > 0 ? (finalProfit / (afterHouseFee - dealerFeeAmount)) * 100 : 0;

        return {
          contractAmount, houseFeeAmount, dealerFeeAmount, creditCardFeeAmount, afterHouseFee,
          totalAfterFees, percentOfContract, vetRate, repRate, finalPerVetPayout, finalPerRepPayout,
          finalTotalVetsPayout, finalTotalRepsPayout, totalRideAlongPayout, altaCalTotalPayout,
          preliminaryProfit, canvasserPayout, confirmerPayout, elisoPayout, prodMSPayout, prodRSPayout,
          prodNCPayout, prodABEPayout, additionalTeamPayout, totalTeamPayout, finalProfit, profitPercent,
          vetsCount, repsCount, numRideAlongs: rideAlongCount
        };
      },

      addCalculator() {
        const calc = {
          id: this.nextId++,
          customerName: '', jobNumber: '', contractAmount: '', cashCheck: '', financeAmount: '',
          dealerFee: '', creditCard: '', creditCardFee: '', houseFeePercent: '', laborMaterial: '',
          numVets: '', numReps: '', rideAlong: '', rideAlongBonus: '', numRideAlongs: '',
          canvasserPercent: '2', confirmerPercent: '0.25', elisoPercent: '1.5',
          prodMSPercent: '0.25', prodMSAmount: '', prodRSPercent: '0.25', prodRSAmount: '',
          prodNCPercent: '0.25', prodNCAmount: '', prodABEPercent: '0.25', prodABEAmount: '',
          moneyThisWeek: '', financeSource: '', bankDropDay: ''
        };
        this.calculators.push(calc);
        this.render();
      },

      deleteCalculator(id) {
        if (this.calculators.length <= 1) { alert('Cannot delete the last calculator'); return; }
        if (confirm('Delete this calculator?')) {
          this.calculators = this.calculators.filter(c => c.id !== id);
          this.render();
        }
      },

     updateField(id, field, value) {
  const calc = this.calculators.find(c => c.id === id);
  if (!calc) return;
  calc[field] = value;
  this.render();        // ‚Üê was this.updateSummary();
}

      render() {
        const container = document.getElementById('calculators');
        container.innerHTML = this.calculators.map((calc, index) => this.renderCalculator(calc, index)).join('');
        this.updateSummary();
      },

      renderCalculator(calc, index) {
        const data = this.calculateOne(calc);
        const deleteBtn = this.calculators.length > 1 ? `<button class="delete-btn" onclick="app.deleteCalculator(${calc.id})">√ó</button>` : '';

        return `
          <div class="calculator">
            ${deleteBtn}
            <div class="calc-header">
              <h2 style="font-size: 18px; font-weight: 700;">FILE #${index + 1}</h2>
              <button class="btn btn-blue" onclick="app.printSingle(${index})" style="padding: 10px 16px;">üñ®Ô∏è</button>
            </div>

            <div class="calc-section">
              <div class="form-grid" style="margin-bottom: 20px;">
                <div class="form-group">
                  <label>JOB NUMBER</label>
                  <input type="text" inputmode="text" value="${calc.jobNumber}" onchange="app.updateField(${calc.id}, 'jobNumber', this.value)" />
                </div>
                <div class="form-group">
                  <label>CUSTOMER NAME</label>
                  <input type="text" inputmode="text" value="${calc.customerName}" onchange="app.updateField(${calc.id}, 'customerName', this.value)" />
                </div>
              </div>

              <div class="section">
                <div class="section-header blue">CONTRACT & PAYMENT</div>
                <div class="section-content">
                  <div class="form-grid">
                    <div class="form-group">
                      <label>CONTRACT AMOUNT</label>
                      <div class="input-with-symbol">
                        <span>$</span>
                        <input type="text" inputmode="decimal" value="${calc.contractAmount}" onchange="app.updateField(${calc.id}, 'contractAmount', this.value)" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label>CASH/CHECK</label>
                      <div class="input-with-symbol">
                        <span>$</span>
                        <input type="text" inputmode="decimal" value="${calc.cashCheck}" onchange="app.updateField(${calc.id}, 'cashCheck', this.value)" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label>LABOR & MATERIAL</label>
                      <div class="input-with-symbol">
                        <span>$</span>
                        <input type="text" inputmode="decimal" value="${calc.laborMaterial}" onchange="app.updateField(${calc.id}, 'laborMaterial', this.value)" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label>FINANCE AMOUNT</label>
                      <div class="input-with-symbol">
                        <span>$</span>
                        <input type="text" inputmode="decimal" value="${calc.financeAmount}" onchange="app.updateField(${calc.id}, 'financeAmount', this.value)" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label>DEALER FEE (% or $)</label>
                      <input type="text" inputmode="decimal" value="${calc.dealerFee}" placeholder="3.5 or $150" onchange="app.updateField(${calc.id}, 'dealerFee', this.value)" />
                      ${data.dealerFeeAmount > 0 ? `<div style="text-align: center; font-weight: 600; margin-top: 5px; color: #2196F3;">${this.fmt(data.dealerFeeAmount)}</div>` : ''}
                    </div>
                    <div class="form-group">
                      <label>HOUSE FEE %</label>
                      <div class="input-with-symbol">
                        <input type="text" inputmode="decimal" value="${calc.houseFeePercent}" onchange="app.updateField(${calc.id}, 'houseFeePercent', this.value)" />
                        <span>%</span>
                      </div>
                      ${data.houseFeeAmount > 0 ? `<div style="text-align: center; font-weight: 600; margin-top: 5px;">${this.fmt(data.houseFeeAmount)}</div>` : ''}
                    </div>
                    <div class="form-group">
                      <label>CREDIT CARD</label>
                      <div class="input-with-symbol">
                        <span>$</span>
                        <input type="text" inputmode="decimal" value="${calc.creditCard}" onchange="app.updateField(${calc.id}, 'creditCard', this.value)" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label>CC FEE (% or $)</label>
                      <input type="text" inputmode="decimal" value="${calc.creditCardFee}" placeholder="3.5 or $35" onchange="app.updateField(${calc.id}, 'creditCardFee', this.value)" />
                      ${data.creditCardFeeAmount > 0 ? `<div style="text-align: center; font-weight: 600; margin-top: 5px; color: #2196F3;">${this.fmt(data.creditCardFeeAmount)}</div>` : ''}
                    </div>
                    <div class="form-group">
                      <label>AFTER HOUSE FEE</label>
                      <div style="text-align: center; padding: 15px; background: #BBDEFB; border-radius: 6px; font-weight: 700; font-size: 18px;">
                        ${this.fmt(data.afterHouseFee)}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-header green">ALTA CAL TEAM</div>
                <div class="section-content">
                  <div class="form-grid" style="margin-bottom: 10px;">
                    <div class="form-group">
                      <label>VETS ON CONTRACT</label>
                      <input type="text" inputmode="decimal" value="${calc.numVets}" onchange="app.updateField(${calc.id}, 'numVets', this.value)" style="text-align: center; font-size: 18px;" />
                    </div>
                    <div class="form-group">
                      <label>REPS ON CONTRACT</label>
                      <input type="text" inputmode="decimal" value="${calc.numReps}" onchange="app.updateField(${calc.id}, 'numReps', this.value)" style="text-align: center; font-size: 18px;" />
                    </div>
                    <div class="form-group">
                      <label>RIDE ALONGS</label>
                      <input type="text" inputmode="decimal" value="${calc.numRideAlongs}" onchange="app.updateField(${calc.id}, 'numRideAlongs', this.value)" style="text-align: center; font-size: 18px;" />
                    </div>
                  </div>

                  ${(data.vetsCount > 0 || data.repsCount > 0) ? `
                    <div class="tier-results">
                      <div class="tier-info">
                        Profit: ${data.percentOfContract.toFixed(1)}% ‚Üí Vet: ${data.vetRate}% | Rep: ${data.repRate}%
                      </div>
                      <div class="tier-grid">
                        ${data.vetsCount > 0 ? `
                          <div class="tier-person">
                            <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">VETS: ${data.vetsCount}</div>
                            <div class="tier-box light">
                              <div class="tier-label">Per Vet</div>
                              <div class="tier-value" style="color: #2E7D32;">${this.fmt(data.finalPerVetPayout)}</div>
                            </div>
                            <div class="tier-box bold">
                              <div class="tier-label">Total</div>
                              <div class="tier-value" style="color: #1B5E20;">${this.fmt(data.finalTotalVetsPayout)}</div>
                            </div>
                          </div>
                        ` : ''}
                        ${data.repsCount > 0 ? `
                          <div class="tier-person">
                            <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">REPS: ${data.repsCount}</div>
                            <div class="tier-box purple-light">
                              <div class="tier-label">Per Rep</div>
                              <div class="tier-value" style="color: #6A1B9A;">${this.fmt(data.finalPerRepPayout)}</div>
                            </div>
                            <div class="tier-box purple-bold">
                              <div class="tier-label">Total</div>
                              <div class="tier-value" style="color: #4A148C;">${this.fmt(data.finalTotalRepsPayout)}</div>
                            </div>
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  ` : ''}

                  <div class="form-grid" style="margin-top: 10px;">
                    <div class="form-group">
                      <label style="color: #D32F2F;">RIDE ALONG FEE (each)</label>
                      <div class="input-with-symbol" style="background: #FFEBEE; border-color: #EF5350;">
                        <span>$</span>
                        <input type="text" inputmode="decimal" value="${calc.rideAlong}" onchange="app.updateField(${calc.id}, 'rideAlong', this.value)" style="background: transparent;" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label style="color: #D32F2F;">RIDE ALONG BONUS (flat)</label>
                      <div class="input-with-symbol" style="background: #FFEBEE; border-color: #EF5350;">
                        <span>$</span>
                        <input type="text" inputmode="decimal" value="${calc.rideAlongBonus}" onchange="app.updateField(${calc.id}, 'rideAlongBonus', this.value)" style="background: transparent;" />
                      </div>
                    </div>
                    ${data.numRideAlongs > 0 ? `
                      <div class="form-group">
                        <label>RIDE ALONG PAYOUT</label>
                        <div style="text-align: center; padding: 12px; background: #FFCDD2; border: 2px solid #EF5350; border-radius: 6px; font-weight: 700; font-size: 16px;">
                          ${this.fmt(data.totalRideAlongPayout)}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-header purple">ADDITIONAL TEAM</div>
                <div class="section-content">
                  <div style="text-align: center; padding: 12px; background: #E1BEE7; border: 2px solid #9C27B0; border-radius: 6px; font-weight: 700; margin-bottom: 12px;">
                    <div style="font-size: 11px; margin-bottom: 4px;">ALTA CAL PROFIT</div>
                    <div style="font-size: 18px;">${this.fmt(data.preliminaryProfit)}</div>
                  </div>

                  <div class="form-grid">
                    <div class="form-group">
                      <label>CANVASSER %</label>
                      <div style="display: flex; gap: 8px; align-items: center;">
                        <input class="pct-input" type="text" inputmode="decimal" value="${calc.canvasserPercent}" onchange="app.updateField(${calc.id}, 'canvasserPercent', this.value)" />
                        <span style="font-size: 13px;">= ${this.fmt(data.canvasserPayout)}</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>CONFIRMER %</label>
                      <div style="display: flex; gap: 8px; align-items: center;">
                        <input class="pct-input" type="text" inputmode="decimal" value="${calc.confirmerPercent}" onchange="app.updateField(${calc.id}, 'confirmerPercent', this.value)" />
                        <span style="font-size: 13px;">= ${this.fmt(data.confirmerPayout)}</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>ELISO %</label>
                      <div style="display: flex; gap: 8px; align-items: center;">
                        <input class="pct-input" type="text" inputmode="decimal" value="${calc.elisoPercent}" onchange="app.updateField(${calc.id}, 'elisoPercent', this.value)" />
                        <span style="font-size: 13px;">= ${this.fmt(data.elisoPayout)}</span>
                      </div>
                    </div>
                  </div>

                  <div class="form-grid" style="margin-top: 12px;">
                    <div class="form-group">
                      <label>PROD MS</label>
                      <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                        <input class="pct-input" type="text" inputmode="decimal" value="${calc.prodMSPercent}" onchange="app.updateField(${calc.id}, 'prodMSPercent', this.value)" />
                        <span>%</span>
                        <input type="text" inputmode="decimal" value="${calc.prodMSAmount}" onchange="app.updateField(${calc.id}, 'prodMSAmount', this.value)" style="width: 90px;" />
                        <span>= ${this.fmt(data.prodMSPayout)}</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>PROD RS</label>
                      <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                        <input class="pct-input" type="text" inputmode="decimal" value="${calc.prodRSPercent}" onchange="app.updateField(${calc.id}, 'prodRSPercent', this.value)" />
                        <span>%</span>
                        <input type="text" inputmode="decimal" value="${calc.prodRSAmount}" onchange="app.updateField(${calc.id}, 'prodRSAmount', this.value)" style="width: 90px;" />
                        <span>= ${this.fmt(data.prodRSPayout)}</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>PROD NC</label>
                      <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                        <input class="pct-input" type="text" inputmode="decimal" value="${calc.prodNCPercent}" onchange="app.updateField(${calc.id}, 'prodNCPercent', this.value)" />
                        <span>%</span>
                        <input type="text" inputmode="decimal" value="${calc.prodNCAmount}" onchange="app.updateField(${calc.id}, 'prodNCAmount', this.value)" style="width: 90px;" />
                        <span>= ${this.fmt(data.prodNCPayout)}</span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label>PROD ABE</label>
                      <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                        <input class="pct-input" type="text" inputmode="decimal" value="${calc.prodABEPercent}" onchange="app.updateField(${calc.id}, 'prodABEPercent', this.value)" />
                        <span>%</span>
                        <input type="text" inputmode="decimal" value="${calc.prodABEAmount}" onchange="app.updateField(${calc.id}, 'prodABEAmount', this.value)" style="width: 90px;" />
                        <span>= ${this.fmt(data.prodABEPayout)}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-header yellow">FINANCE & BANK</div>
                <div class="section-content">
                  <div class="form-grid">
                    <div class="form-group">
                      <label>MONEY THIS WEEK</label>
                      <div class="input-with-symbol">
                        <span>$</span>
                        <input type="text" inputmode="decimal" value="${calc.moneyThisWeek}" onchange="app.updateField(${calc.id}, 'moneyThisWeek', this.value)" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label>FINANCE SOURCE</label>
                      <select onchange="app.updateField(${calc.id}, 'financeSource', this.value)">
                        <option value="" ${calc.financeSource === '' ? 'selected' : ''}>Select</option>
                        <option value="Finance" ${calc.financeSource === 'Finance' ? 'selected' : ''}>Finance</option>
                        <option value="Cash" ${calc.financeSource === 'Cash' ? 'selected' : ''}>Cash</option>
                        <option value="Both" ${calc.financeSource === 'Both' ? 'selected' : ''}>Both</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>BANK DROP DAY</label>
                      <select onchange="app.updateField(${calc.id}, 'bankDropDay', this.value)">
                        <option value="" ${calc.bankDropDay === '' ? 'selected' : ''}>Select Day</option>
                        ${DAYS.map(d => `<option value="${d}" ${calc.bankDropDay === d ? 'selected' : ''}>${d}</option>`).join('')}
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div class="big-card blue">
                  <div class="label">ALTA CAL PAYOUT</div>
                  <div class="value">${this.fmt(data.totalTeamPayout)}</div>
                </div>
                <div class="big-card green">
                  <div class="label">ALTA CAL PROFIT</div>
                  <div class="value">${this.fmt(data.finalProfit)}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      },

      updateSummary() {
        let totalPayout = 0, totalProfit = 0, totalMoney = 0, totalAfterHouse = 0;
        this.calculators.forEach(calc => {
          const data = this.calculateOne(calc);
          totalPayout += data.totalTeamPayout;
          totalProfit += data.finalProfit;
          totalMoney += this.parseValue(calc.moneyThisWeek);
          totalAfterHouse += (data.afterHouseFee - data.dealerFeeAmount);
        });
        const profitPercent = totalAfterHouse > 0 ? (totalProfit / totalAfterHouse) * 100 : 0;
        document.getElementById('summaryCards').innerHTML = `
          <div class="summary-card blue">
            <div class="label">TOTAL PAYOUT</div>
            <div class="value">${this.fmt(totalPayout)}</div>
          </div>
          <div class="summary-card purple">
            <div class="label">TOTAL PROFIT</div>
            <div class="value">${this.fmt(totalProfit)}</div>
          </div>
          <div class="summary-card green">
            <div class="label">PROFIT %</div>
            <div class="value">${profitPercent.toFixed(2)}%</div>
          </div>
          <div class="summary-card red">
            <div class="label">MONEY THIS WEEK</div>
            <div class="value">${this.fmt(totalMoney)}</div>
          </div>`;
      },

      printSingle(index) {
        const calc = this.calculators[index];
        const data = this.calculateOne(calc);
        const week = document.getElementById('collectionWeek').value || 'Not Specified';
        const html = `
          <div style="padding: 20px; font-size: 11px;">
            <h1 style="text-align: center; font-size: 20px; margin-bottom: 15px; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">
              FILE #${index + 1} - ${calc.customerName || 'N/A'}
            </h1>
            ${week !== 'Not Specified' ? `<div style="text-align: center; font-weight: 700; margin-bottom: 15px;">Week: ${week}</div>` : ''}

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div style="background: #BBDEFB; padding: 10px; border-radius: 4px;">
                <strong>Contract:</strong> ${this.fmt(data.contractAmount)}<br />
                <strong>After House:</strong> ${this.fmt(data.afterHouseFee)}
              </div>
              <div style="background: #C8E6C9; padding: 10px; border-radius: 4px;">
                <strong>ALTA CAL Payout:</strong> ${this.fmt(data.totalTeamPayout)}<br />
                <strong>Profit Rate:</strong> ${data.percentOfContract.toFixed(1)}%
              </div>
              <div style="background: #E1BEE7; padding: 10px; border-radius: 4px;">
                <strong>ALTA CAL Profit:</strong> ${this.fmt(data.finalProfit)}<br />
                <strong>Vet ${data.vetRate}% | Rep ${data.repRate}%</strong>
              </div>
            </div>

            <div class="no-print" style="margin-top: 20px; text-align: center;">
              <button onclick="window.print()" style="background: #2196F3; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer; margin-right: 10px;">üñ®Ô∏è PRINT</button>
              <button onclick="app.closePrint()" style="background: #757575; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer;">CLOSE</button>
            </div>
          </div>`;
        document.getElementById('printView').innerHTML = html;
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('printView').style.display = 'block';
      },

      showPrintReport() {
        const week = document.getElementById('collectionWeek').value || 'Not Specified';
        let totalPayout = 0, totalProfit = 0, totalMoney = 0, totalAfterHouse = 0;

        let rows = '';
        this.calculators.forEach((calc, index) => {
          const data = this.calculateOne(calc);
          totalPayout += data.totalTeamPayout;
          totalProfit += data.finalProfit;
          totalMoney += this.parseValue(calc.moneyThisWeek);
          totalAfterHouse += (data.afterHouseFee - data.dealerFeeAmount);

          rows += `
            <tr>
              <td style="border: 1px solid #000; padding: 6px; text-align: center;">${index + 1}</td>
              <td style="border: 1px solid #000; padding: 6px;">${calc.jobNumber || '-'}</td>
              <td style="border: 1px solid #000; padding: 6px;">${calc.customerName || '-'}</td>
              <td style="border: 1px solid #000; padding: 6px; text-align: right;">${this.fmt(data.contractAmount)}</td>
              <td style="border: 1px solid #000; padding: 6px; text-align: right;">${this.fmt(data.totalTeamPayout)}</td>
              <td style="border: 1px solid #000; padding: 6px; text-align: right;">${this.fmt(data.finalProfit)}</td>
              <td style="border: 1px solid #000; padding: 6px; text-align: right;">${data.profitPercent.toFixed(2)}%</td>
              <td style="border: 1px solid #000; padding: 6px; text-align: right; font-weight: 700;">${this.fmt(this.parseValue(calc.moneyThisWeek))}</td>
              <td style="border: 1px solid #000; padding: 6px; text-align: center;">${calc.bankDropDay || '-'}</td>
            </tr>`;
        });

        const profitPercent = totalAfterHouse > 0 ? (totalProfit / totalAfterHouse) * 100 : 0;

        const html = `
          <div style="padding: 20px; font-size: 10px;">
            <h1 style="text-align: center; font-size: 18px; margin-bottom: 10px;">COMBINED PROFIT REPORT</h1>
            ${week !== 'Not Specified' ? `<h2 style="text-align: center; font-size: 14px; margin-bottom: 15px;">Week: ${week}</h2>` : ''}

            <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; margin-bottom: 20px;">
              <thead>
                <tr style="background: #e0e0e0;">
                  <th style="border: 1px solid #000; padding: 8px;">#</th>
                  <th style="border: 1px solid #000; padding: 8px;">Job</th>
                  <th style="border: 1px solid #000; padding: 8px;">Customer</th>
                  <th style="border: 1px solid #000; padding: 8px;">Contract</th>
                  <th style="border: 1px solid #000; padding: 8px;">Payout</th>
                  <th style="border: 1px solid #000; padding: 8px;">Profit</th>
                  <th style="border: 1px solid #000; padding: 8px;">%</th>
                  <th style="border: 1px solid #000; padding: 8px;">This Week</th>
                  <th style="border: 1px solid #000; padding: 8px;">Bank Day</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                <tr style="background: #FFF9C4; font-weight: 700;">
                  <td colspan="4" style="border: 1px solid #000; padding: 8px; text-align: right;">TOTALS:</td>
                  <td style="border: 1px solid #000; padding: 8px; text-align: right;">${this.fmt(totalPayout)}</td>
                  <td style="border: 1px solid #000; padding: 8px; text-align: right;">${this.fmt(totalProfit)}</td>
                  <td style="border: 1px solid #000; padding: 8px; text-align: right;">${profitPercent.toFixed(2)}%</td>
                  <td style="border: 1px solid #000; padding: 8px; text-align: right;">${this.fmt(totalMoney)}</td>
                  <td style="border: 1px solid #000; padding: 8px; text-align: center;">‚Äî</td>
                </tr>
              </tbody>
            </table>

            <div class="no-print" style="margin-top: 20px; text-align: center;">
              <button onclick="window.print()" style="background: #2196F3; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer; margin-right: 10px;">üñ®Ô∏è PRINT</button>
              <button onclick="app.closePrint()" style="background: #757575; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer;">CLOSE</button>
            </div>
          </div>`;

        document.getElementById('printView').innerHTML = html;
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('printView').style.display = 'block';
      },

      closePrint() {
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('printView').style.display = 'none';
      },

      showSaveDialog() {
        const name = prompt('Enter report name:');
        if (name && name.trim()) {
          const data = {
            name: name.trim(),
            date: new Date().toISOString(),
            collectionWeek: document.getElementById('collectionWeek').value,
            calculators: this.calculators
          };
          const key = 'report_' + Date.now();
          localStorage.setItem(key, JSON.stringify(data));
          alert('Report saved!');
        }
      }
    };

    window.addEventListener('DOMContentLoaded', () => app.init());
  </script>
</body>
</html>
