<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Combined Profit Calculator</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; background:#f5f5f5; padding:15px; }
    input,select,button { font-size:16px !important; }

    .container { max-width:1400px; margin:0 auto; }
    .btn { padding:14px 24px; border:none; border-radius:8px; font-weight:600; cursor:pointer; touch-action:manipulation; }
    .btn-primary{ background:#4CAF50; color:#fff; }
    .btn-blue{ background:#2196F3; color:#fff; }

    .header { background:#fff; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    .header h1 { color:#1976D2; font-size:24px; margin-bottom:15px; }
    .header-buttons { display:flex; gap:10px; flex-wrap:wrap; }

    .week-input { background:#fff; padding:15px; border-radius:12px; margin-bottom:20px; text-align:center; }
    .week-input input { padding:12px; border:2px solid #2196F3; border-radius:6px; width:100%; max-width:400px; }

    .summary-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-bottom:20px; }
    .summary-card { background:linear-gradient(135deg,var(--c1),var(--c2)); padding:15px; border-radius:8px; color:#fff; text-align:center; }
    .summary-card.blue{ --c1:#42A5F5; --c2:#2196F3; }
    .summary-card.purple{ --c1:#AB47BC; --c2:#9C27B0; }
    .summary-card.green{ --c1:#4CAF50; --c2:#45a049; }
    .summary-card.red{ --c1:#EF5350; --c2:#E53935; }
    .summary-card .label{ font-size:11px; font-weight:600; margin-bottom:5px; }
    .summary-card .value{ font-size:20px; font-weight:700; }

    .calculator { background:#fff; border:3px solid #ccc; border-radius:12px; margin-bottom:20px; position:relative; }
    .calc-header { background:#BBDEFB; padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #000; }
    .delete-btn { position:absolute; top:-10px; right:-10px; background:#EF5350; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; cursor:pointer; z-index:10; }
    .calc-section { padding:20px; }

    .section { margin-bottom:20px; border:3px solid #e0e0e0; border-radius:8px; }
    .section-header { padding:12px; font-weight:600; text-align:center; }
    .section-header.blue{ background:#BBDEFB; color:#1565C0; }
    .section-header.green{ background:#C8E6C9; color:#2E7D32; }
    .section-header.purple{ background:#E1BEE7; color:#6A1B9A; }
    .section-header.yellow{ background:#FFF9C4; color:#F57F17; }
    .section-content { padding:15px; background:#fafafa; }

    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px; }
    .form-group { display:flex; flex-direction:column; }
    .form-group label { font-size:12px; font-weight:600; margin-bottom:6px; color:#555; }
    .form-group input,.form-group select { padding:12px; border:2px solid #e0e0e0; border-radius:6px; font-size:16px; }

    .input-with-symbol { display:flex; align-items:center; background:#fff; border:2px solid #e0e0e0; border-radius:6px; padding:0 12px; }
    .input-with-symbol input { border:none; flex:1; padding:12px 0; text-align:right; font-size:16px; }

    .big-card { background:linear-gradient(135deg,var(--c1),var(--c2)); color:#fff; padding:20px; text-align:center; border-radius:8px; }
    .big-card .label { font-size:12px; font-weight:600; margin-bottom:8px; }
    .big-card .value { font-size:28px; font-weight:700; }

    .add-btn { background:#2196F3; color:#fff; font-weight:700; padding:18px 35px; border-radius:50px; border:none; font-size:16px; cursor:pointer; display:flex; align-items:center; gap:12px; margin:20px auto; }

    .tier-results { background:#fff; padding:12px; border-radius:6px; border:2px solid #e0e0e0; margin-top:10px; }
    .tier-info { text-align:center; font-size:11px; font-weight:600; padding:8px; background:#f5f5f5; border-radius:4px; margin-bottom:10px; }
    .tier-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
    .tier-person { border:2px solid #e0e0e0; border-radius:6px; padding:12px; }
    .tier-box { text-align:center; padding:8px; border-radius:4px; margin-bottom:6px; }
    .tier-box.light{ background:#f5f5f5; border:1px solid #ddd; }
    .tier-box.bold{ background:#e8f5e9; border:2px solid #4CAF50; }
    .tier-box.purple-light{ background:#f3e5f5; border:1px solid #ddd; }
    .tier-box.purple-bold{ background:#f3e5f5; border:2px solid #9C27B0; }
    .tier-box .tier-label{ font-size:10px; font-weight:600; }
    .tier-box .tier-value{ font-size:16px; font-weight:700; }

    @media print { .no-print{ display:none !important; } .print-view{ display:block !important; } }
    .print-view { display:none; }

    /* Bottom Totals (always at the bottom of page content) */
    .footer-totals { margin:18px 0 8px 0; display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
    .footer-card { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:14px; text-align:center; }
    .footer-card .label { font-size:12px; font-weight:700; color:#555; margin-bottom:6px; }
    .footer-card .value { font-size:22px; font-weight:800; }
  </style>
</head>
<body>
  <div class="container">
    <div id="mainView" class="no-print">
      <div class="header">
        <h1>COMBINED PROFIT CALCULATOR</h1>
        <div class="header-buttons">
          <button id="saveBtn" class="btn btn-primary">üíæ SAVE</button>
          <button id="printReportBtn" class="btn btn-blue">üñ®Ô∏è PRINT</button>
        </div>
      </div>

      <div class="week-input">
        <label style="display:block; font-weight:700; margin-bottom:10px;">COLLECTION WEEK PERIOD</label>
        <input type="text" inputmode="text" id="collectionWeek" placeholder="10/1-10/6" />
      </div>

      <div id="summaryCards" class="summary-cards"></div>
      <div id="calculators"></div>

      <!-- Always-visible totals at the very bottom -->
      <div id="footerTotals" class="footer-totals"></div>

      <div style="text-align:center;">
        <button id="addBtn" class="add-btn"><span style="font-size:24px;">+</span> ADD NEW FILE</button>
      </div>
    </div>

    <div id="printView" class="print-view"></div>
  </div>

  <script>
    const state = { calculators: [], nextId: 1 };

    // ---------- Utils ----------
    const fmt = v => {
      const n = Number.isFinite(v) ? v : parseFloat(v || 0);
      // correct regex (no double-escaping)
      return '$' + (n || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };
    const parseValue = v => {
      if (v === undefined || v === null) return 0;
      const p = parseFloat(String(v).replace(/[,$%]/g,'').trim());
      return Number.isFinite(p) ? p : 0;
    };
    const parseFeeAmount = (baseAmount, feeInput) => {
      const base = parseValue(baseAmount);
      if (!feeInput && feeInput !== 0) return 0;
      const raw = String(feeInput).trim();
      if (!raw) return 0;
      const hasPct = raw.includes('%');
      const hasDol = raw.includes('$');
      const num = parseValue(raw);
      if (hasDol) return num;                 // $150
      if (hasPct) return (base * num) / 100;  // 3.5%
      if (num > 100) return num;              // 150 -> dollars
      if (num > 1) return (base * num) / 100; // 3.5 -> percent
      if (num > 0) return base * num;         // 0.035 -> percent as fraction
      return 0;
    };

    // ---------- Math Core ----------
    const calculateOne = (c) => {
      const contractAmount   = parseValue(c.contractAmount);
      const laborMaterial    = parseValue(c.laborMaterial);
      const houseFeePercent  = parseValue(c.houseFeePercent);
      const houseFeeAmount   = (contractAmount * houseFeePercent) / 100;

      const dealerFeeAmount     = parseFeeAmount(c.financeAmount, c.dealerFee);
      const creditCardFeeAmount = parseFeeAmount(c.creditCard, c.creditCardFee);

      const afterHouseFee    = contractAmount - houseFeeAmount;
      const totalAfterFees   = afterHouseFee - laborMaterial - dealerFeeAmount;
      const percentOfContract= afterHouseFee > 0 ? (totalAfterFees / afterHouseFee) * 100 : 0;

      let vetRate = 25;
      if (percentOfContract >= 50)      vetRate = 55;
      else if (percentOfContract >= 40) vetRate = 45;
      else if (percentOfContract >= 33) vetRate = 35;

      let repRate = 20;
      if (percentOfContract >= 50)      repRate = 40;
      else if (percentOfContract >= 40) repRate = 30;
      else if (percentOfContract >= 33) repRate = 25;

      const vetsCount   = parseValue(c.numVets);
      const repsCount   = parseValue(c.numReps);
      const totalPeople = Math.max(0, vetsCount + repsCount);

      const vetCommissionTotal = (totalAfterFees * vetRate) / 100;
      const repCommissionTotal = (totalAfterFees * repRate) / 100;

      const rideAlongCount     = parseValue(c.numRideAlongs);
      const rideAlongFeeEach   = parseValue(c.rideAlong);
      const rideAlongBonus     = parseValue(c.rideAlongBonus);
      const totalRideAlongFee  = rideAlongFeeEach * rideAlongCount;
      const totalRideAlongPayout = totalRideAlongFee + rideAlongBonus;

      const perPersonSharedFees = totalPeople > 0 ? (creditCardFeeAmount + totalRideAlongFee) / totalPeople : 0;
      const perVetBase = totalPeople > 0 ? (vetCommissionTotal / totalPeople) : 0;
      const perRepBase = totalPeople > 0 ? (repCommissionTotal / totalPeople) : 0;

      const finalPerVetPayout     = perVetBase - perPersonSharedFees;
      const finalPerRepPayout     = perRepBase - perPersonSharedFees;
      const finalTotalVetsPayout  = finalPerVetPayout * vetsCount;
      const finalTotalRepsPayout  = finalPerRepPayout * repsCount;

      const altaCalTotalPayout = laborMaterial + finalTotalVetsPayout + finalTotalRepsPayout + totalRideAlongPayout + creditCardFeeAmount;
      const preliminaryProfit  = afterHouseFee - altaCalTotalPayout - dealerFeeAmount;

      const canvasserPayout = preliminaryProfit * (parseValue(c.canvasserPercent) / 100);
      const confirmerPayout = contractAmount   * (parseValue(c.confirmerPercent) / 100);
      const elisoPayout     = contractAmount   * (parseValue(c.elisoPercent) / 100);
      const prodMSPayout    = parseValue(c.prodMSAmount)  * (parseValue(c.prodMSPercent) / 100);
      const prodRSPayout    = parseValue(c.prodRSAmount)  * (parseValue(c.prodRSPercent) / 100);
      const prodNCPayout    = parseValue(c.prodNCAmount)  * (parseValue(c.prodNCPercent) / 100);
      const prodABEPayout   = parseValue(c.prodABEAmount) * (parseValue(c.prodABEPercent) / 100);

      const additionalTeamPayout = canvasserPayout + confirmerPayout + elisoPayout + prodMSPayout + prodRSPayout + prodNCPayout + prodABEPayout;
      const totalTeamPayout      = altaCalTotalPayout + additionalTeamPayout;
      const finalProfit          = preliminaryProfit - additionalTeamPayout;
      const profitPercent        = (afterHouseFee - dealerFeeAmount) > 0 ? (finalProfit / (afterHouseFee - dealerFeeAmount)) * 100 : 0;

      return {
        contractAmount, houseFeeAmount, dealerFeeAmount, creditCardFeeAmount, afterHouseFee,
        totalAfterFees, percentOfContract, vetRate, repRate, finalPerVetPayout, finalPerRepPayout,
        finalTotalVetsPayout, finalTotalRepsPayout, totalRideAlongPayout, altaCalTotalPayout,
        preliminaryProfit, canvasserPayout, confirmerPayout, elisoPayout, prodMSPayout, prodRSPayout,
        prodNCPayout, prodABEPayout, additionalTeamPayout, totalTeamPayout, finalProfit, profitPercent,
        vetsCount, repsCount, numRideAlongs: rideAlongCount
      };
    };

    // ---------- Aggregation ----------
    const aggregateTotals = () => {
      let totalPayout = 0, totalProfit = 0, totalMoney = 0, totalAfterHouse = 0;
      state.calculators.forEach(c => {
        const d = calculateOne(c);
        totalPayout     += d.totalTeamPayout;
        totalProfit     += d.finalProfit;
        totalMoney      += parseValue(c.moneyThisWeek);
        totalAfterHouse += (d.afterHouseFee - d.dealerFeeAmount);
      });
      const profitPercent = totalAfterHouse > 0 ? (totalProfit / totalAfterHouse) * 100 : 0;
      return { totalPayout, totalProfit, totalMoney, profitPercent };
    };

    // ---------- Rendering ----------
    const optSel = (cur, val) => cur === val ? 'selected' : '';

    const renderCalculator = (c, index) => {
      const d = calculateOne(c);
      const delBtn = state.calculators.length > 1
        ? `<button class="delete-btn" data-role="delete" data-id="${c.id}">√ó</button>` : '';

      return `
        <div class="calculator" data-calc-id="${c.id}">
          ${delBtn}
          <div class="calc-header">
            <h2 style="font-size:18px; font-weight:700;">FILE #${index + 1}</h2>
            <button class="btn btn-blue" data-role="print-single" data-index="${index}" style="padding:10px 16px;">üñ®Ô∏è</button>
          </div>

          <div class="calc-section">
            <div class="form-grid" style="margin-bottom:20px;">
              <div class="form-group">
                <label>JOB NUMBER</label>
                <input type="text" data-field="jobNumber" value="${c.jobNumber ?? ''}" />
              </div>
              <div class="form-group">
                <label>CUSTOMER NAME</label>
                <input type="text" data-field="customerName" value="${c.customerName ?? ''}" />
              </div>
            </div>

            <div class="section">
              <div class="section-header blue">CONTRACT & PAYMENT</div>
              <div class="section-content">
                <div class="form-grid">
                  <div class="form-group">
                    <label>CONTRACT AMOUNT</label>
                    <div class="input-with-symbol"><span>$</span>
                      <input type="text" data-field="contractAmount" value="${c.contractAmount ?? ''}" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>CASH/CHECK</label>
                    <div class="input-with-symbol"><span>$</span>
                      <input type="text" data-field="cashCheck" value="${c.cashCheck ?? ''}" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>LABOR & MATERIAL</label>
                    <div class="input-with-symbol"><span>$</span>
                      <input type="text" data-field="laborMaterial" value="${c.laborMaterial ?? ''}" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>FINANCE AMOUNT</label>
                    <div class="input-with-symbol"><span>$</span>
                      <input type="text" data-field="financeAmount" value="${c.financeAmount ?? ''}" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>DEALER FEE (% or $)</label>
                    <input type="text" data-field="dealerFee" value="${c.dealerFee ?? ''}" placeholder="3.5 or $150" />
                    ${d.dealerFeeAmount > 0 ? `<div style="text-align:center; font-weight:600; margin-top:5px; color:#2196F3;">${fmt(d.dealerFeeAmount)}</div>` : ''}
                  </div>
                  <div class="form-group">
                    <label>HOUSE FEE %</label>
                    <div class="input-with-symbol">
                      <input type="text" data-field="houseFeePercent" value="${c.houseFeePercent ?? ''}" /><span>%</span>
                    </div>
                    ${d.houseFeeAmount > 0 ? `<div style="text-align:center; font-weight:600; margin-top:5px;">${fmt(d.houseFeeAmount)}</div>` : ''}
                  </div>
                  <div class="form-group">
                    <label>CREDIT CARD</label>
                    <div class="input-with-symbol"><span>$</span>
                      <input type="text" data-field="creditCard" value="${c.creditCard ?? ''}" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>CC FEE (% or $)</label>
                    <input type="text" data-field="creditCardFee" value="${c.creditCardFee ?? ''}" placeholder="3.5 or $35" />
                    ${d.creditCardFeeAmount > 0 ? `<div style="text-align:center; font-weight:600; margin-top:5px; color:#2196F3;">${fmt(d.creditCardFeeAmount)}</div>` : ''}
                  </div>
                  <div class="form-group">
                    <label>AFTER HOUSE FEE</label>
                    <div style="text-align:center; padding:15px; background:#BBDEFB; border-radius:6px; font-weight:700; font-size:18px;">
                      ${fmt(d.afterHouseFee)}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-header green">ALTA CAL TEAM</div>
              <div class="section-content">
                <div class="form-grid" style="mar

