<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Combined Profit Calculator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 15px; }
    input, select, button { font-size: 16px !important; }
    .container { max-width: 1400px; margin: 0 auto; }
    .btn { padding: 14px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; touch-action: manipulation; }
    .btn-primary { background: #4CAF50; color: white; }
    .btn-blue { background: #2196F3; color: white; }
    .btn-red { background: #EF5350; color: white; }
    .btn-gray { background: #757575; color: white; }
    .header { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #1976D2; font-size: 24px; margin-bottom: 15px; }
    .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .week-input { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
    .week-input input { font-size: 16px; padding: 12px; border: 2px solid #2196F3; border-radius: 6px; width: 100%; max-width: 400px; }
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .summary-card { background: linear-gradient(135deg, var(--c1), var(--c2)); padding: 15px; border-radius: 8px; color: white; text-align: center; }
    .summary-card.blue { --c1: #42A5F5; --c2: #2196F3; }
    .summary-card.purple { --c1: #AB47BC; --c2: #9C27B0; }
    .summary-card.green { --c1: #4CAF50; --c2: #45a049; }
    .summary-card.red { --c1: #EF5350; --c2: #E53935; }
    .summary-card .label { font-size: 11px; font-weight: 600; margin-bottom: 5px; }
    .summary-card .value { font-size: 20px; font-weight: 700; }
    .calculator { background: white; border: 3px solid #ccc; border-radius: 12px; margin-bottom: 20px; position: relative; }
    .calc-header { background: #BBDEFB; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; }
    .delete-btn { position: absolute; top: -10px; right: -10px; background: #EF5350; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 20px; cursor: pointer; z-index: 10; }
    .calc-section { padding: 20px; }
    .section { margin-bottom: 20px; border: 3px solid #e0e0e0; border-radius: 8px; }
    .section-header { padding: 12px; font-weight: 600; text-align: center; }
    .section-header.blue { background: #BBDEFB; color: #1565C0; }
    .section-header.green { background: #C8E6C9; color: #2E7D32; }
    .section-header.purple { background: #E1BEE7; color: #6A1B9A; }
    .section-header.yellow { background: #FFF9C4; color: #F57F17; }
    .section-content { padding: 15px; background: #fafafa; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #555; }
    .form-group input, .form-group select { padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; }
    .input-with-symbol { display: flex; align-items: center; background: white; border: 2px solid #e0e0e0; border-radius: 6px; padding: 0 12px; }
    .input-with-symbol input { border: none; flex: 1; padding: 12px 0; text-align: right; font-size: 16px; }
    .big-card { background: linear-gradient(135deg, var(--c1), var(--c2)); color: white; padding: 20px; text-align: center; border-radius: 8px; }
    .big-card .label { font-size: 12px; font-weight: 600; margin-bottom: 8px; }
    .big-card .value { font-size: 28px; font-weight: 700; }
    .add-btn { background: #2196F3; color: white; font-weight: 700; padding: 18px 35px; border-radius: 50px; border: none; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin: 20px auto; }
    .tier-results { background: white; padding: 12px; border-radius: 6px; border: 2px solid #e0e0e0; margin-top: 10px; }
    .tier-info { text-align: center; font-size: 11px; font-weight: 600; padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px; }
    .tier-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .tier-person { border: 2px solid #e0e0e0; border-radius: 6px; padding: 12px; }
    .tier-box { text-align: center; padding: 8px; border-radius: 4px; margin-bottom: 6px; }
    .tier-box.light { background: #f5f5f5; border: 1px solid #ddd; }
    .tier-box.bold { background: #e8f5e9; border: 2px solid #4CAF50; }
    .tier-box.purple-light { background: #f3e5f5; border: 1px solid #ddd; }
    .tier-box.purple-bold { background: #f3e5f5; border: 2px solid #9C27B0; }
    .tier-box .tier-label { font-size: 10px; font-weight: 600; }
    .tier-box .tier-value { font-size: 16px; font-weight: 700; }
    @media print { .no-print { display: none !important; } .print-view { display: block !important; } }
    .print-view { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="mainView" class="no-print">
      <div class="header">
        <h1>COMBINED PROFIT CALCULATOR</h1>
        <div class="header-buttons">
          <button class="btn btn-primary" onclick="app.showSaveDialog()">üíæ SAVE</button>
          <button class="btn btn-blue" onclick="app.showPrintReport()">üñ®Ô∏è PRINT</button>
        </div>
      </div>

      <div class="week-input">
        <label style="display: block; font-weight: 700; margin-bottom: 10px;">COLLECTION WEEK PERIOD</label>
        <input type="text" inputmode="text" id="collectionWeek" placeholder="10/1-10/6" />
      </div>

      <div id="summaryCards" class="summary-cards"></div>
      <div id="calculators"></div>

      <div style="text-align: center;">
        <button class="add-btn" onclick="app.addCalculator()">
          <span style="font-size: 24px;">+</span> ADD NEW FILE
        </button>
      </div>
    </div>

    <div id="printView" class="print-view"></div>
  </div>

  <script>
    const app = {
      calculators: [],
      nextId: 1,

      init() {
        this.addCalculator();
        document.getElementById('collectionWeek').addEventListener('input', () => this.updateSummary());
      },

      fmt(value) {
        const n = Number.isFinite(value) ? value : parseFloat(value || 0);
        return '$' + (n || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      },

      parseValue(value) {
        if (value === undefined || value === null) return 0;
        const parsed = parseFloat(String(value).replace(/[,\$%]/g, '').trim());
        return Number.isFinite(parsed) ? parsed : 0;
      },

      parseFeeAmount(baseAmount, feeInput) {
        const base = this.parseValue(baseAmount);
        if (!feeInput && feeInput !== 0) return 0;
        const raw = String(feeInput).trim();
        if (!raw) return 0;
        const hasPct = raw.includes('%');
        const hasDol = raw.includes('$');
        const num = this.parseValue(raw);
        if (hasDol) return num;
        if (hasPct) return (base * num) / 100;
        if (num > 100) return num;
        if (num > 1) return (base * num) / 100;
        if (num > 0) return base * num;
        return 0;
      },

      calculateOne(data) {
        const contractAmount = this.parseValue(data.contractAmount);
        const laborMaterial = this.parseValue(data.laborMaterial);
        const houseFeePercent = this.parseValue(data.houseFeePercent);
        const houseFeeAmount = (contractAmount * houseFeePercent) / 100;

        const dealerFeeAmount = this.parseFeeAmount(data.financeAmount, data.dealerFee);
        const creditCardFeeAmount = this.parseFeeAmount(data.creditCard, data.creditCardFee);

        const afterHouseFee = contractAmount - houseFeeAmount;
        const totalAfterFees = afterHouseFee - laborMaterial - dealerFeeAmount;
        const percentOfContract = afterHouseFee > 0 ? (totalAfterFees / afterHouseFee) * 100 : 0;

        let vetRate = 25;
        if (percentOfContract >= 50) vetRate = 55;
        else if (percentOfContract >= 40) vetRate = 45;
        else if (percentOfContract >= 33) vetRate = 35;

        let repRate = 20;
        if (percentOfContract >= 50) repRate = 40;
        else if (percentOfContract >= 40) repRate = 30;
        else if (percentOfContract >= 33) repRate = 25;

        const vetsCount = this.parseValue(data.numVets);
        const repsCount = this.parseValue(data.numReps);
        const totalPeople = Math.max(0, vetsCount + repsCount);

        const vetCommissionTotal = (totalAfterFees * vetRate) / 100;
        const repCommissionTotal = (totalAfterFees * repRate) / 100;

        const rideAlongCount = this.parseValue(data.numRideAlongs);
        const rideAlongFeeEach = this.parseValue(data.rideAlong);
        const rideAlongBonusAmount = this.parseValue(data.rideAlongBonus);
        const totalRideAlongFee = rideAlongFeeEach * rideAlongCount;
        const totalRideAlongPayout = totalRideAlongFee + rideAlongBonusAmount;

        const perPersonSharedFees = totalPeople > 0 ? (creditCardFeeAmount + totalRideAlongFee) / totalPeople : 0;

        const perVetBase = totalPeople > 0 ? vetCommissionTotal / totalPeople : 0;
        const perRepBase = totalPeople > 0 ? repCommissionTotal / totalPeople : 0;

        const finalPerVetPayout = perVetBase - perPersonSharedFees;
        const finalPerRepPayout = perRepBase - perPersonSharedFees;
        const finalTotalVetsPayout = finalPerVetPayout * vetsCount;
        const finalTotalRepsPayout = finalPerRepPayout * repsCount;

        const altaCalTotalPayout = laborMaterial + finalTotalVetsPayout + finalTotalRepsPayout + totalRideAlongPayout + creditCardFeeAmount;
        const preliminaryProfit = afterHouseFee - altaCalTotalPayout - dealerFeeAmount;

        const canvasserPayout = preliminaryProfit * (this.parseValue(data.canvasserPercent) / 100);
        const confirmerPayout = contractAmount * (this.parseValue(data.confirmerPercent) / 100);
        const elisoPayout = contractAmount * (this.parseValue(data.elisoPercent) / 100);
        const prodMSPayout = this.parseValue(data.prodMSAmount) * (this.parseValue(data.prodMSPercent) / 100);
        const prodRSPayout = this.parseValue(data.prodRSAmount) * (this.parseValue(data.prodRSPercent) / 100);
        const prodNCPayout = this.parseValue(data.prodNCAmount) * (this.parseValue(data.prodNCPercent) / 100);
        const prodABEPayout = this.parseValue(data.prodABEAmount) * (this.parseValue(data.prodABEPercent) / 100);

        const additionalTeamPayout = canvasserPayout + confirmerPayout + elisoPayout + prodMSPayout + prodRSPayout + prodNCPayout + prodABEPayout;
        const totalTeamPayout = altaCalTotalPayout + additionalTeamPayout;
        const finalProfit = preliminaryProfit - additionalTeamPayout;
        const profitPercent = (afterHouseFee - dealerFeeAmount) > 0 ? (finalProfit / (afterHouseFee - dealerFeeAmount)) * 100 : 0;

        return {
          contractAmount, houseFeeAmount, dealerFeeAmount, creditCardFeeAmount, afterHouseFee,
          totalAfterFees, percentOfContract, vetRate, repRate, finalPerVetPayout, finalPerRepPayout,
          finalTotalVetsPayout, finalTotalRepsPayout, totalRideAlongPayout, altaCalTotalPayout,
          preliminaryProfit, canvasserPayout, confirmerPayout, elisoPayout, prodMSPayout, prodRSPayout,
          prodNCPayout, prodABEPayout, additionalTeamPayout, totalTeamPayout, finalProfit, profitPercent,
          vetsCount, repsCount, numRideAlongs: rideAlongCount
        };
      },

      addCalculator() {
        const calc = {
          id: this.nextId++,
          customerName: '', jobNumber: '', contractAmount: '', cashCheck: '', financeAmount: '',
          dealerFee: '', creditCard: '', creditCardFee: '', houseFeePercent: '', laborMaterial: '',
          numVets: '', numReps: '', rideAlong: '', rideAlongBonus: '', numRideAlongs: '',
          canvasserPercent: '2', confirmerPercent: '0.25', elisoPercent: '1.5',
          prodMSPercent: '0.25', prodMSAmount: '', prodRSPercent: '0.25', prodRSAmount: '',
          prodNCPercent: '0.25', prodNCAmount: '', prodABEPercent: '0.25', prodABEAmount: '',
          moneyThisWeek: '', financeSource: '', bankDropDay: ''
        };
        this.calculators.push(calc);
        this.render();
      },

      deleteCalculator(id) {
        if (this.calculators.length <= 1) {
          alert('Cannot delete the last calculator');
          return;
        }
        if (confirm('Delete this calculator?')) {
          this.calculators = this.calculators.filter(c => c.id !== id);
          this.render();
        }
      },

      // Re-render after each field update so computed boxes refresh
      updateField(id, field, value) {
        const calc = this.calculators.find(c => c.id === id);
        if (calc) {
          calc[field] = value;
          this.render();
        }
      },

      render() {
        const container = document.getEl
