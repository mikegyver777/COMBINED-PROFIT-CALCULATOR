<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Combined Profit Calculator</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; background:#f5f5f5; padding:15px; }
    input,select,button { font-size:16px !important; }

    .container { max-width:1400px; margin:0 auto; }
    .btn { padding:14px 24px; border:none; border-radius:8px; font-weight:600; cursor:pointer; touch-action:manipulation; }
    .btn-primary{ background:#4CAF50; color:#fff; }
    .btn-blue{ background:#2196F3; color:#fff; }

    .header { background:#fff; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    .header h1 { color:#1976D2; font-size:24px; margin-bottom:15px; }
    .header-buttons { display:flex; gap:10px; flex-wrap:wrap; }

    .week-input { background:#fff; padding:15px; border-radius:12px; margin-bottom:20px; text-align:center; }
    .week-input input { padding:12px; border:2px solid #2196F3; border-radius:6px; width:100%; max-width:400px; }

    .summary-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-bottom:20px; }
    .summary-card { background:linear-gradient(135deg,var(--c1),var(--c2)); padding:15px; border-radius:8px; color:#fff; text-align:center; }
    .summary-card.blue{ --c1:#42A5F5; --c2:#2196F3; }
    .summary-card.purple{ --c1:#AB47BC; --c2:#9C27B0; }
    .summary-card.green{ --c1:#4CAF50; --c2:#45a049; }
    .summary-card.red{ --c1:#EF5350; --c2:#E53935; }
    .summary-card .label{ font-size:11px; font-weight:600; margin-bottom:5px; }
    .summary-card .value{ font-size:20px; font-weight:700; }

    .calculator { background:#fff; border:3px solid #ccc; border-radius:12px; margin-bottom:20px; position:relative; }
    .calc-header { background:#BBDEFB; padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #000; }
    .delete-btn { position:absolute; top:-10px; right:-10px; background:#EF5350; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; cursor:pointer; z-index:10; }
    .calc-section { padding:20px; }

    .section { margin-bottom:20px; border:3px solid #e0e0e0; border-radius:8px; }
    .section-header { padding:12px; font-weight:600; text-align:center; }
    .section-header.blue{ background:#BBDEFB; color:#1565C0; }
    .section-header.green{ background:#C8E6C9; color:#2E7D32; }
    .section-header.purple{ background:#E1BEE7; color:#6A1B9A; }
    .section-header.yellow{ background:#FFF9C4; color:#F57F17; }
    .section-content { padding:15px; background:#fafafa; }

    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px; }
    .form-group { display:flex; flex-direction:column; }
    .form-group label { font-size:12px; font-weight:600; margin-bottom:6px; color:#555; }
    .form-group input,.form-group select { padding:12px; border:2px solid #e0e0e0; border-radius:6px; font-size:16px; }

    .input-with-symbol { display:flex; align-items:center; background:#fff; border:2px solid #e0e0e0; border-radius:6px; padding:0 12px; }
    .input-with-symbol input { border:none; flex:1; padding:12px 0; text-align:right; font-size:16px; }

    .big-card { background:linear-gradient(135deg,var(--c1),var(--c2)); color:#fff; padding:20px; text-align:center; border-radius:8px; }
    .big-card .label { font-size:12px; font-weight:600; margin-bottom:8px; }
    .big-card .value { font-size:28px; font-weight:700; }

    .tier-results { background:#fff; padding:12px; border-radius:6px; border:2px solid #e0e0e0; margin-top:10px; }
    .tier-info { text-align:center; font-size:11px; font-weight:600; padding:8px; background:#f5f5f5; border-radius:4px; margin-bottom:10px; }
    .tier-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
    .tier-person { border:2px solid #e0e0e0; border-radius:6px; padding:12px; }
    .tier-box { text-align:center; padding:8px; border-radius:4px; margin-bottom:6px; }
    .tier-box.light{ background:#f5f5f5; border:1px solid #ddd; }
    .tier-box.bold{ background:#e8f5e9; border:2px solid #4CAF50; }
    .tier-box.purple-light{ background:#f3e5f5; border:1px solid #ddd; }
    .tier-box.purple-bold{ background:#f3e5f5; border:2px solid #9C27B0; }
    .tier-box .tier-label{ font-size:10px; font-weight:600; }
    .tier-box .tier-value{ font-size:16px; font-weight:700; }

    @media print { .no-print{ display:none !important; } .print-view{ display:block !important; } }
    .print-view { display:none; }

    /* Footer totals */
    .footer-totals { margin:18px 0 8px 0; display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
    .footer-card { background:#fff; border:2px solid #e0e0e0; border-radius:10px; padding:14px; text-align:center; }
    .footer-card .label { font-size:12px; font-weight:700; color:#555; margin-bottom:6px; }
    .footer-card .value { font-size:22px; font-weight:800; }

    /* Hide-on-zero helper */
    .hide-when-zero[data-val="0"] { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="mainView" class="no-print">
      <div class="header">
        <h1>COMBINED PROFIT CALCULATOR</h1>
        <div class="header-buttons">
          <button id="saveBtn" class="btn btn-primary">üíæ SAVE</button>
          <button id="printReportBtn" class="btn btn-blue">üñ®Ô∏è PRINT</button>
        </div>
      </div>

      <div class="week-input">
        <label style="display:block; font-weight:700; margin-bottom:10px;">COLLECTION WEEK PERIOD</label>
        <input type="text" id="collectionWeek" placeholder="10/1-10/6" />
      </div>

      <div id="summaryCards" class="summary-cards"></div>
      <div id="calculators"></div>

      <div id="footerTotals" class="footer-totals"></div>

      <div style="text-align:center;">
        <button id="addBtn" class="add-btn"><span style="font-size:24px;">+</span> ADD NEW FILE</button>
      </div>
    </div>

    <div id="printView" class="print-view"></div>
  </div>

  <script>
    // ---------- State ----------
    const state = { calculators: [], nextId: 1 };

    // ---------- Utils ----------
    const fmt = v => {
      const n = Number.isFinite(v) ? v : parseFloat(v || 0);
      return '$' + (n || 0).toFixed(2).replace(/\B(?=(\\d{3})+(?!\\d))/g, ',');
    };
    const parseValue = v => {
      if (v === undefined || v === null) return 0;
      const p = parseFloat(String(v).replace(/[,$%]/g,'').trim());
      return Number.isFinite(p) ? p : 0;
    };
    const parseFeeAmount = (baseAmount, feeInput) => {
      const base = parseValue(baseAmount);
      if (!feeInput && feeInput !== 0) return 0;
      const raw = String(feeInput).trim();
      if (!raw) return 0;
      const hasPct = raw.includes('%');
      const hasDol = raw.includes('$');
      const num = parseValue(raw);
      if (hasDol) return num;
      if (hasPct) return (base * num) / 100;
      if (num > 100) return num;
      if (num > 1) return (base * num) / 100;
      if (num > 0) return base * num;
      return 0;
    };

    // ---------- Math ----------
    function compute(calc){
      const contractAmount   = parseValue(calc.contractAmount);
      const laborMaterial    = parseValue(calc.laborMaterial);
      const houseFeePercent  = parseValue(calc.houseFeePercent);
      const houseFeeAmount   = (contractAmount * houseFeePercent) / 100;

      const dealerFeeAmount     = parseFeeAmount(calc.financeAmount, calc.dealerFee);
      const creditCardFeeAmount = parseFeeAmount(calc.creditCard, calc.creditCardFee);

      const afterHouseFee    = contractAmount - houseFeeAmount;
      const totalAfterFees   = afterHouseFee - laborMaterial - dealerFeeAmount;
      const percentOfContract= afterHouseFee > 0 ? (totalAfterFees / afterHouseFee) * 100 : 0;

      let vetRate = 25;
      if (percentOfContract >= 50)      vetRate = 55;
      else if (percentOfContract >= 40) vetRate = 45;
      else if (percentOfContract >= 33) vetRate = 35;

      let repRate = 20;
      if (percentOfContract >= 50)      repRate = 40;
      else if (percentOfContract >= 40) repRate = 30;
      else if (percentOfContract >= 33) repRate = 25;

      const vetsCount   = parseValue(calc.numVets);
      const repsCount   = parseValue(calc.numReps);
      const totalPeople = Math.max(0, vetsCount + repsCount);

      const vetCommissionTotal = (totalAfterFees * vetRate) / 100;
      const repCommissionTotal = (totalAfterFees * repRate) / 100;

      const rideAlongCount     = parseValue(calc.numRideAlongs);
      const rideAlongFeeEach   = parseValue(calc.rideAlong);
      const rideAlongBonus     = parseValue(calc.rideAlongBonus);
      const totalRideAlongFee  = rideAlongFeeEach * rideAlongCount;
      const totalRideAlongPayout = totalRideAlongFee + rideAlongBonus;

      const perPersonSharedFees = totalPeople > 0 ? (creditCardFeeAmount + totalRideAlongFee) / totalPeople : 0;
      const perVetBase = totalPeople > 0 ? (vetCommissionTotal / totalPeople) : 0;
      const perRepBase = totalPeople > 0 ? (repCommissionTotal / totalPeople) : 0;

      const finalPerVetPayout     = perVetBase - perPersonSharedFees;
      const finalPerRepPayout     = perRepBase - perPersonSharedFees;
      const finalTotalVetsPayout  = finalPerVetPayout * vetsCount;
      const finalTotalRepsPayout  = finalPerRepPayout * repsCount;

      const altaCalTotalPayout = laborMaterial + finalTotalVetsPayout + finalTotalRepsPayout + totalRideAlongPayout + creditCardFeeAmount;
      const preliminaryProfit  = afterHouseFee - altaCalTotalPayout - dealerFeeAmount;

      const canvasserPayout = preliminaryProfit * (parseValue(calc.canvasserPercent) / 100);
      const confirmerPayout = contractAmount   * (parseValue(calc.confirmerPercent) / 100);
      const elisoPayout     = contractAmount   * (parseValue(calc.elisoPercent) / 100);
      const prodMSPayout    = parseValue(calc.prodMSAmount)  * (parseValue(calc.prodMSPercent) / 100);
      const prodRSPayout    = parseValue(calc.prodRSAmount)  * (parseValue(calc.prodRSPercent) / 100);
      const prodNCPayout    = parseValue(calc.prodNCAmount)  * (parseValue(calc.prodNCPercent) / 100);
      const prodABEPayout   = parseValue(calc.prodABEAmount) * (parseValue(calc.prodABEPercent) / 100);

      const additionalTeamPayout = canvasserPayout + confirmerPayout + elisoPayout + prodMSPayout + prodRSPayout + prodNCPayout + prodABEPayout;
      const totalTeamPayout      = altaCalTotalPayout + additionalTeamPayout;
      const finalProfit          = preliminaryProfit - additionalTeamPayout;
      const profitPercent        = (afterHouseFee - dealerFeeAmount) > 0 ? (finalProfit / (afterHouseFee - dealerFeeAmount)) * 100 : 0;

      return {
        contractAmount, houseFeeAmount, dealerFeeAmount, creditCardFeeAmount, afterHouseFee,
        totalAfterFees, percentOfContract, vetRate, repRate, finalPerVetPayout, finalPerRepPayout,
        finalTotalVetsPayout, finalTotalRepsPayout, totalRideAlongPayout, altaCalTotalPayout,
        preliminaryProfit, canvasserPayout, confirmerPayout, elisoPayout, prodMSPayout, prodRSPayout,
        prodNCPayout, prodABEPayout, additionalTeamPayout, totalTeamPayout, finalProfit, profitPercent,
        vetsCount, repsCount, numRideAlongs: rideAlongCount
      };
    }

    function aggregate(){
      let totalPayout=0, totalProfit=0, totalMoney=0, totalAfterHouse=0;
      state.calculators.forEach(c=>{
        const d = compute(c);
        totalPayout     += d.totalTeamPayout;
        totalProfit     += d.finalProfit;
        totalMoney      += parseValue(c.moneyThisWeek);
        totalAfterHouse += (d.afterHouseFee - d.dealerFeeAmount);
      });
      const profitPercent = totalAfterHouse>0 ? (totalProfit/totalAfterHouse)*100 : 0;
      return { totalPayout, totalProfit, totalMoney, profitPercent };
    }

    // ---------- DOM builders (one-time) ----------
    function feeDisplayHTML(key, color, extraStyle=''){
      // always present; we toggle via data-val and CSS
      return `<div class="fee-display ${key}" data-bind="${key}" data-val="0"
                style="text-align:center; font-weight:600; margin-top:5px; ${extraStyle}">${fmt(0)}</div>`;
    }

    function tierBlockHTML(type){
      const colorLight = type==='vet' ? '#2E7D32' : '#6A1B9A';
      const colorBold  = type==='vet' ? '#1B5E20' : '#4A148C';
      const labelType  = type==='vet' ? 'VETS' : 'REPS';
      const bindPer    = type==='vet' ? 'finalPerVetPayout' : 'finalPerRepPayout';
      const bindTotal  = type==='vet' ? 'finalTotalVetsPayout' : 'finalTotalRepsPayout';
      const bindCount  = type==='vet' ? 'vetsCount' : 'repsCount';
      return `
      <div class="tier-person" data-show-when="${bindCount}">
        <div style="font-weight:700; text-align:center; margin-bottom:8px;">
          ${labelType}: <span data-bind="${bindCount}">0</span>
        </div>
        <div class="tier-box light">
          <div class="tier-label">Per ${type==='vet'?'Vet':'Rep'}</div>
          <div class="tier-value" style="color:${colorLight};" data-bind="${bindPer}">${fmt(0)}</div>
        </div>
        <div class="tier-box ${type==='vet'?'bold':'purple-bold'}">
          <div class="tier-label">Total</div>
          <div class="tier-value" style="color:${colorBold};" data-bind="${bindTotal}">${fmt(0)}</div>
        </div>
      </div>`;
    }

    function calcHTML(c, idx){
      const delBtn = state.calculators.length>1
        ? `<button class="delete-btn" data-role="delete" data-id="${c.id}">√ó</button>` : '';
      // tabindex flows left‚Üíright by DOM order; no re-render on input preserves focus and iOS keyboard
      return `
      <div class="calculator" data-calc-id="${c.id}">
        ${delBtn}
        <div class="calc-header">
          <h2 style="font-size:18px; font-weight:700;">FILE #${idx+1}</h2>
          <button class="btn btn-blue" data-role="print-single" data-index="${idx}" style="padding:10px 16px;">üñ®Ô∏è</button>
        </div>

        <div class="calc-section">
          <div class="form-grid" style="margin-bottom:20px;">
            <div class="form-group">
              <label>JOB NUMBER</label>
              <input type="text" data-field="jobNumber" inputmode="text" />
            </div>
            <div class="form-group">
              <label>CUSTOMER NAME</label>
              <input type="text" data-field="customerName" inputmode="text" />
            </div>
          </div>

          <div class="section">
            <div class="section-header blue">CONTRACT & PAYMENT</div>
            <div class="section-content">
              <div class="form-grid">
                <div class="form-group">
                  <label>CONTRACT AMOUNT</label>
                  <div class="input-with-symbol"><span>$</span>
                    <input type="text" data-field="contractAmount" inputmode="decimal" />
                  </div>
                </div>
                <div class="form-group">
                  <label>CASH/CHECK</label>
                  <div class="input-with-symbol"><span>$</span>
                    <input type="text" data-field="cashCheck" inputmode="decimal" />
                  </div>
                </div>
                <div class="form-group">
                  <label>LABOR & MATERIAL</label>
                  <div class="input-with-symbol"><span>$</span>
                    <input type="text" data-field="laborMaterial" inputmode="decimal" />
                  </div>
                </div>
                <div class="form-group">
                  <label>FINANCE AMOUNT</label>
                  <div class="input-with-symbol"><span>$</span>
                    <input type="text" data-field="financeAmount" inputmode="decimal" />
                  </div>
                </div>
                <div class="form-group">
                  <label>DEALER FEE (% or $)</label>
                  <input type="text" data-field="dealerFee" inputmode="decimal" placeholder="3.5 or $150" />
                  ${feeDisplayHTML('dealerFeeAmount','blue','color:#2196F3;')}
                </div>
                <div class="form-group">
                  <label>HOUSE FEE %</label>
                  <div class="input-with-symbol">
                    <input type="text" data-field="houseFeePercent" inputmode="decimal" /><span>%</span>
                  </div>
                  ${feeDisplayHTML('houseFeeAmount','','')}
                </div>
                <div class="form-group">
                  <label>CREDIT CARD</label>
                  <div class="input-with-symbol"><span>$</span>
                    <input type="text" data-field="creditCard" inputmode="decimal" />
                  </div>
                </div>
                <div class="form-group">
                  <label>CC FEE (% or $)</label>
                  <input type="text" data-field="creditCardFee" inputmode="decimal" placeholder="3.5 or $35" />
                  ${feeDisplayHTML('creditCardFeeAmount','blue','color:#2196F3;')}
                </div>
                <div class="form-group">
                  <label>AFTER HOUSE FEE</label>
                  <div style="text-align:center; padding:15px; background:#BBDEFB; border-radius:6px; font-weight:700; font-size:18px;"
                       data-bind="afterHouseFee">${fmt(0)}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-header green">ALTA CAL TEAM</div>
            <div class="section-content">
              <div class="form-grid" style="margin-bottom:10px;">
                <div class="form-group">
                  <label>VETS ON CONTRACT</label>
                  <input type="text" data-field="numVets" inputmode="numeric" style="text-align:center; font-size:18px;" />
                </div>
                <div class="form-group">
                  <label>REPS ON CONTRACT</label>
                  <input type="text" data-field="numReps" inputmode="numeric" style="text-align:center; font-size:18px;" />
                </div>
                <div class="form-group">
                  <label>RIDE ALONGS</label>
                  <input type="text" data-field="numRideAlongs" inputmode="numeric" style="text-align:center; font-size:18px;" />
                </div>
              </div>

              <div class="tier-results" data-bind-block="tier">
                <div class="tier-info">
                  Profit: <span data-bind="percentOfContract">0.0</span>% ‚Üí Vet: <span data-bind="vetRate">25</span>% | Rep: <span data-bind="repRate">20</span>%
                </div>
                <div class="tier-grid">
                  ${tierBlockHTML('vet')}
                  ${tierBlockHTML('rep')}
                </div>
              </div>

              <div class="form-grid" style="margin-top:10px;">
                <div class="form-group">
                  <label style="color:#D32F2F;">RIDE ALONG FEE (each)</label>
                  <div class="input-with-symbol" style="background:#FFEBEE; border-color:#EF5350;">
                    <span>$</span><input type="text" data-field="rideAlong" inputmode="decimal" style="background:transparent;" />
                  </div>
                </div>
                <div class="form-group">
                  <label style="color:#D32F2F;">RIDE ALONG BONUS (flat)</label>
                  <div class="input-with-symbol" style="background:#FFEBEE; border-color:#EF5350;">
                    <span>$</span><input type="text" data-field="rideAlongBonus" inputmode="decimal" style="background:transparent;" />
                  </div>
                </div>
                <div class="form-group hide-when-zero" data-val="0" data-show-when="numRideAlongs">
                  <label>RIDE ALONG PAYOUT</label>
                  <div style="text-align:center; padding:12px; background:#FFCDD2; border:2px solid #EF5350; border-radius:6px; font-weight:700; font-size:16px;"
                       data-bind="totalRideAlongPayout">${fmt(0)}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-header purple">ADDITIONAL TEAM</div>
            <div class="section-content">
              <div style="text-align:center; padding:12px; background:#E1BEE7; border:2px solid #9C27B0; border-radius:6px; font-weight:700; margin-bottom:12px;">
                <div style="font-size:11px; margin-bottom:4px;">ALTA CAL PROFIT</div>
                <div style="font-size:18px;" data-bind="preliminaryProfit">${fmt(0)}</div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label>CANVASSER %</label>
                  <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" data-field="canvasserPercent" inputmode="decimal" style="width:70px;" />
                    <span style="font-size:13px;">% = <span data-bind="canvasserPayout">${fmt(0)}</span></span>
                  </div>
                </div>
                <div class="form-group">
                  <label>CONFIRMER %</label>
                  <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" data-field="confirmerPercent" inputmode="decimal" style="width:70px;" />
                    <span style="font-size:13px;">% = <span data-bind="confirmerPayout">${fmt(0)}</span></span>
                  </div>
                </div>
                <div class="form-group">
                  <label>ELISO %</label>
                  <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" data-field="elisoPercent" inputmode="decimal" style="width:70px;" />
                    <span style="font-size:13px;">% = <span data-bind="elisoPayout">${fmt(0)}</span></span>
                  </div>
                </div>
              </div>

              <div class="form-grid" style="margin-top:12px;">
                <!-- Four producer lines -->
                ${['MS','RS','NC','ABE'].map(tag=>`
                  <div class="form-group">
                    <label>PROD ${tag}</label>
                    <div style="display:flex; gap:6px; align-items:center; font-size:13px;">
                      <input type="text" data-field="prod${tag}Percent" inputmode="decimal" style="width:50px;" /><span>%</span>
                      <input type="text" data-field="prod${tag}Amount"  inputmode="decimal" style="width:80px;" />
                      <span>= <span data-bind="prod${tag}Payout">${fmt(0)}</span></span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-header yellow">FINANCE & BANK</div>
            <div class="section-content">
              <div class="form-grid">
                <div class="form-group">
                  <label>MONEY THIS WEEK</label>
                  <div class="input-with-symbol"><span>$</span>
                    <input type="text" data-field="moneyThisWeek" inputmode="decimal" />
                  </div>
                </div>
                <div class="form-group">
                  <label>FINANCE SOURCE</label>
                  <select data-field="financeSource">
                    <option value="">Select</option>
                    <option value="Finance">Finance</option>
                    <option value="Cash">Cash</option>
                    <option value="Both">Both</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>BANK DROP DAY</label>
                  <select data-field="bankDropDay">
                    <option value="">Select Day</option>
                    <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                    <option>Thursday</option><option>Friday</option><option>Saturday</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
            <div class="big-card" style="--c1:#42A5F5;--c2:#2196F3;">
              <div class="label">ALTA CAL PAYOUT</div>
              <div class="value" data-bind="totalTeamPayout">${fmt(0)}</div>
            </div>
            <div class="big-card" style="--c1:#4CAF50;--c2:#45a049;">
              <div class="label">ALTA CAL PROFIT</div>
              <div class="value" data-bind="finalProfit">${fmt(0)}</div>
            </div>
          </div>
        </div>
      </div>`;
    }

    // ---------- Render helpers (one-time create, then patch) ----------
    function renderAllOnce(){
      const wrap = document.getElementById('calculators');
      wrap.innerHTML = state.calculators.map((c,i)=>calcHTML(c,i)).join('');
      // seed values into inputs
      state.calculators.forEach((c)=>{
        const root = document.querySelector(`.calculator[data-calc-id="${c.id}"]`);
        if (!root) return;
        root.querySelectorAll('input[data-field],select[data-field]').forEach(el=>{
          const f = el.getAttribute('data-field');
          if (f in c) el.value = c[f] ?? '';
        });
        updateOutputs(c.id); // initial numbers
      });
      renderTopAndFooterTotals();
    }

    function setBind(root, key, value){
      root.querySelectorAll(`[data-bind="${key}"]`).forEach(el=>{
        el.textContent = (typeof value==='number') ? fmt(value) : String(value);
      });
      // for hide-when-zero toggles
      root.querySelectorAll(`.hide-when-zero [data-bind="${key}"]`).forEach(el=>{
        const box = el.closest('.hide-when-zero');
        if (box) box.setAttribute('data-val', (+value===0 ? '0' : '1'));
      });
      // generic visibility: any container asking to show when key nonzero
      root.querySelectorAll(`[data-show-when="${key}"]`).forEach(el=>{
        if (+value>0) el.style.display = '';
        else el.style.display = 'none';
      });
    }

    function setValToggle(root, key, value){
      root.querySelectorAll(`[data-bind="${key}"]`).forEach(el=>{
        el.textContent = fmt(value);
      });
      root.querySelectorAll(`[data-bind="${key}"]`).forEach(el=>{
        const box = el.closest('[data-val]');
        if (box) box.setAttribute('data-val', (+value===0 ? '0' : '1'));
      });
    }

    function updateOutputs(calcId){
      const calc = state.calculators.find(x=>x.id===calcId);
      if (!calc) return;
      const root = document.querySelector(`.calculator[data-calc-id="${calcId}"]`);
      if (!root) return;
      const d = compute(calc);

      // simple numbers
      ['afterHouseFee','preliminaryProfit','percentOfContract','vetRate','repRate',
       'finalPerVetPayout','finalPerRepPayout','finalTotalVetsPayout','finalTotalRepsPayout',
       'totalRideAlongPayout','totalTeamPayout','finalProfit',
       'vetsCount','repsCount','houseFeeAmount'].forEach(k=>{
        const val = (k==='percentOfContract') ? d[k].toFixed(1)
                  : (k==='vetRate'||k==='repRate'||k==='vetsCount'||k==='repsCount') ? d[k]
                  : d[k];
        setBind(root, k, val);
      });

      // fee displays with hide-on-zero
      setValToggle(root,'dealerFeeAmount', d.dealerFeeAmount);
      setValToggle(root,'creditCardFeeAmount', d.creditCardFeeAmount);

      // refresh top/footer totals without touching inputs
      renderTopAndFooterTotals();
    }

    function renderTopAndFooterTotals(){
      const a = aggregate();
      document.getElementById('summaryCards').innerHTML = `
        <div class="summary-card blue"><div class="label">TOTAL PAYOUT</div><div class="value">${fmt(a.totalPayout)}</div></div>
        <div class="summary-card purple"><div class="label">TOTAL PROFIT</div><div class="value">${fmt(a.totalProfit)}</div></div>
        <div class="summary-card green"><div class="label">PROFIT %</div><div class="value">${a.profitPercent.toFixed(2)}%</div></div>
        <div class="summary-card red"><div class="label">MONEY THIS WEEK</div><div class="value">${fmt(a.totalMoney)}</div></div>
      `;
      document.getElementById('footerTotals').innerHTML = `
        <div class="footer-card"><div class="label">TOTAL PAYOUT</div><div class="value">${fmt(a.totalPayout)}</div></div>
        <div class="footer-card"><div class="label">TOTAL PROFIT</div><div class="value">${fmt(a.totalProfit)}</div></div>
        <div class="footer-card"><div class="label">PROFIT %</div><div class="value">${a.profitPercent.toFixed(2)}%</div></div>
        <div class="footer-card"><div class="label">MONEY THIS WEEK</div><div class="value">${fmt(a.totalMoney)}</div></div>
      `;
    }

    // ---------- Actions ----------
    function addCalculator(){
      state.calculators.push({
        id: state.nextId++,
        customerName:'', jobNumber:'', contractAmount:'', cashCheck:'', financeAmount:'',
        dealerFee:'', creditCard:'', creditCardFee:'', houseFeePercent:'', laborMaterial:'',
        numVets:'', numReps:'', rideAlong:'', rideAlongBonus:'', numRideAlongs:'',
        canvasserPercent:'2', confirmerPercent:'0.25', elisoPercent:'1.5',
        prodMSPercent:'0.25', prodMSAmount:'', prodRSPercent:'0.25', prodRSAmount:'',
        prodNCPercent:'0.25', prodNCAmount:'', prodABEPercent:'0.25', prodABEAmount:'',
        moneyThisWeek:'', financeSource:'', bankDropDay:''
      });
    }

    function printSingle(index){
      const c = state.calculators[index];
      const d = compute(c);
      const week = document.getElementById('collectionWeek').value || 'Not Specified';
      const html = `
        <div style="padding:20px; font-size:11px;">
          <h1 style="text-align:center; font-size:20px; margin-bottom:15px; border-bottom:2px solid #2196F3; padding-bottom:10px;">
            FILE #${index + 1} - ${c.customerName || 'N/A'}
          </h1>
          ${week !== 'Not Specified' ? `<div style="text-align:center; font-weight:700; margin-bottom:15px;">Week: ${week}</div>` : ''}

          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
            <div style="background:#BBDEFB; padding:10px; border-radius:4px;">
              <strong>Contract:</strong> ${fmt(d.contractAmount)}<br />
              <strong>After House:</strong> ${fmt(d.afterHouseFee)}
            </div>
            <div style="background:#C8E6C9; padding:10px; border-radius:4px;">
              <strong>ALTA CAL Payout:</strong> ${fmt(d.totalTeamPayout)}<br />
              <strong>Profit Rate:</strong> ${d.percentOfContract.toFixed(1)}%
            </div>
            <div style="background:#E1BEE7; padding:10px; border-radius:4px;">
              <strong>ALTA CAL Profit:</strong> ${fmt(d.finalProfit)}<br />
              <strong>Vet ${d.vetRate}% | Rep ${d.repRate}%</strong>
            </div>
          </div>

          ${(d.vetsCount > 0 || d.repsCount > 0) ? `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
              ${d.vetsCount > 0 ? `
                <div style="border:2px solid #4CAF50; padding:10px; border-radius:4px;">
                  <div style="font-weight:700; margin-bottom:5px;">VETS: ${d.vetsCount}</div>
                  <div>Per: ${fmt(d.finalPerVetPayout)}</div>
                  <div><strong>Total: ${fmt(d.finalTotalVetsPayout)}</strong></div>
                </div>` : ``}
              ${d.repsCount > 0 ? `
                <div style="border:2px solid #9C27B0; padding:10px; border-radius:4px;">
                  <div style="font-weight:700; margin-bottom:5px;">REPS: ${d.repsCount}</div>
                  <div>Per: ${fmt(d.finalPerRepPayout)}</div>
                  <div><strong>Total: ${fmt(d.finalTotalRepsPayout)}</strong></div>
                </div>` : ``}
            </div>` : ``}

          <div class="no-print" style="margin-top:20px; text-align:center;">
            <button onclick="window.print()" style="background:#2196F3; color:#fff; padding:12px 30px; border:none; border-radius:6px; font-size:16px; font-weight:700; cursor:pointer; margin-right:10px;">üñ®Ô∏è PRINT</button>
            <button id="closePrintBtn" style="background:#757575; color:#fff; padding:12px 30px; border:none; border-radius:6px; font-size:16px; font-weight:700; cursor:pointer;">CLOSE</button>
          </div>
        </div>`;
      document.getElementById('printView').innerHTML = html;
      document.getElementById('mainView').style.display = 'none';
      document.getElementById('printView').style.display = 'block';
      document.getElementById('closePrintBtn').onclick = () => {
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('printView').style.display = 'none';
      };
    }

    function showPrintReport(){
      const week = document.getElementById('collectionWeek').value || 'Not Specified';
      let totalPayout=0, totalProfit=0, totalMoney=0, totalAfterHouse=0, rows='';
      state.calculators.forEach((c,idx)=>{
        const d = compute(c);
        totalPayout     += d.totalTeamPayout;
        totalProfit     += d.finalProfit;
        totalMoney      += parseValue(c.moneyThisWeek);
        totalAfterHouse += (d.afterHouseFee - d.dealerFeeAmount);
        rows += `
          <tr>
            <td style="border:1px solid #000; padding:6px; text-align:center;">${idx + 1}</td>
            <td style="border:1px solid #000; padding:6px;">${c.jobNumber || '-'}</td>
            <td style="border:1px solid #000; padding:6px;">${c.customerName || '-'}</td>
            <td style="border:1px solid #000; padding:6px; text-align:right;">${fmt(d.contractAmount)}</td>
            <td style="border:1px solid #000; padding:6px; text-align:right;">${fmt(d.totalTeamPayout)}</td>
            <td style="border:1px solid #000; padding:6px; text-align:right;">${fmt(d.finalProfit)}</td>
            <td style="border:1px solid #000; padding:6px; text-align:right;">${d.profitPercent.toFixed(2)}%</td>
            <td style="border:1px solid #000; padding:6px; text-align:right; font-weight:700;">${fmt(parseValue(c.moneyThisWeek))}</td>
          </tr>`;
      });
      const profitPercent = totalAfterHouse>0 ? (totalProfit/totalAfterHouse)*100 : 0;
      const html = `
        <div style="padding:20px; font-size:10px;">
          <h1 style="text-align:center; font-size:18px; margin-bottom:10px;">COMBINED PROFIT REPORT</h1>
          ${week !== 'Not Specified' ? `<h2 style="text-align:center; font-size:14px; margin-bottom:15px;">Week: ${week}</h2>` : ''}

          <table style="width:100%; border-collapse:collapse; border:2px solid #000; margin-bottom:20px;">
            <thead>
              <tr style="background:#e0e0e0;">
                <th style="border:1px solid #000; padding:8px;">#</th>
                <th style="border:1px solid #000; padding:8px;">Job</th>
                <th style="border:1px solid #000; padding:8px;">Customer</th>
                <th style="border:1px solid #000; padding:8px;">Contract</th>
                <th style="border:1px solid #000; padding:8px;">Payout</th>
                <th style="border:1px solid #000; padding:8px;">Profit</th>
                <th style="border:1px solid #000; padding:8px;">%</th>
                <th style="border:1px solid #000; padding:8px;">This Week</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
              <tr style="background:#FFF9C4; font-weight:700;">
                <td colspan="4" style="border:1px solid #000; padding:8px; text-align:right;">TOTALS:</td>
                <td style="border:1px solid #000; padding:8px; text-align:right;">${fmt(totalPayout)}</td>
                <td style="border:1px solid #000; padding:8px; text-align:right;">${fmt(totalProfit)}</td>
                <td style="border:1px solid #000; padding:8px; text-align:right;">${profitPercent.toFixed(2)}%</td>
                <td style="border:1px solid #000; padding:8px; text-align:right;">${fmt(totalMoney)}</td>
              </tr>
            </tbody>
          </table>

          <div class="no-print" style="margin-top:20px; text-align:center;">
            <button onclick="window.print()" style="background:#2196F3; color:#fff; padding:12px 30px; border:none; border-radius:6px; font-size:16px; font-weight:700; cursor:pointer; margin-right:10px;">üñ®Ô∏è PRINT</button>
            <button id="closePrintBtn2" style="background:#757575; color:#fff; padding:12px 30px; border:none; border-radius:6px; font-size:16px; font-weight:700; cursor:pointer;">CLOSE</button>
          </div>
        </div>`;
      document.getElementById('printView').innerHTML = html;
      document.getElementById('mainView').style.display = 'none';
      document.getElementById('printView').style.display = 'block';
      document.getElementById('closePrintBtn2').onclick = () => {
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('printView').style.display = 'none';
      };
    }

    function saveDialog(){
      const name = prompt('Enter report name:');
      if (name && name.trim()){
        const data = {
          name: name.trim(),
          date: new Date().toISOString(),
          collectionWeek: document.getElementById('collectionWeek').value,
          calculators: state.calculators
        };
        localStorage.setItem('report_' + Date.now(), JSON.stringify(data));
        alert('Report saved!');
      }
    }

    // ---------- Boot & Events ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      addCalculator(); // at least one calc
      // one-time render
      renderAllOnce();

      // seed defaults that matter for keyboard behaviour
      state.calculators.forEach(c=>{
        c.canvasserPercent='2'; c.confirmerPercent='0.25'; c.elisoPercent='1.5';
        c.prodMSPercent='0.25'; c.prodRSPercent='0.25'; c.prodNCPercent='0.25'; c.prodABEPercent='0.25';
      });
      // write seeds into DOM inputs
      state.calculators.forEach(c=>{
        const root = document.querySelector(`.calculator[data-calc-id="${c.id}"]`);
        if (!root) return;
        root.querySelectorAll('input[data-field],select[data-field]').forEach(el=>{
          const f = el.getAttribute('data-field'); el.value = c[f] ?? el.value ?? '';
        });
        updateOutputs(c.id);
      });

      // Field input: update state + outputs ONLY (no re-render, keeps focus & iOS keypad)
      document.getElementById('calculators').addEventListener('input', (e)=>{
        const root = e.target.closest('.calculator'); if(!root) return;
        const id   = parseInt(root.getAttribute('data-calc-id'),10);
        const f    = e.target.getAttribute('data-field'); if(!f) return;
        const v    = e.target.value;
        const c    = state.calculators.find(x=>x.id===id);
        if(!c) return;
        c[f] = v;
        updateOutputs(id);
      });

      // Click handlers
      document.getElementById('calculators').addEventListener('click',(e)=>{
        const btn = e.target.closest('[data-role]'); if(!btn) return;
        const role = btn.getAttribute('data-role');
        if(role==='delete'){
          if(state.calculators.length<=1){ alert('Cannot delete the last calculator'); return; }
          const id = parseInt(btn.getAttribute('data-id'),10);
          // remove from state then re-render once
          state.calculators = state.calculators.filter(x=>x.id!==id);
          document.getElementById('calculators').innerHTML = '';
          renderAllOnce();
        }
        if(role==='print-single'){
          const index = parseInt(btn.getAttribute('data-index'),10);
          printSingle(index);
        }
      });

      // Week input affects only top/bottom summaries
      document.getElementById('collectionWeek').addEventListener('input', renderTopAndFooterTotals);

      // Global buttons
      document.getElementById('addBtn').addEventListener('click', ()=>{
        addCalculator();
        // re-render once to add a new calculator block (inputs retain focus on the old one)
        renderAllOnce();
      });
      document.getElementById('saveBtn').addEventListener('click', saveDialog);
      document.getElementById('printReportBtn').addEventListener('click', showPrintReport);
    });
  </script>
</body>
</html>
